<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chirag Sharma">
<meta name="dcterms.date" content="2023-01-09">
<meta name="description" content="In this post, we’ll demonstrate how to scape data from flipkart using BeautifulSoup &amp; Selenium using Python.">

<title>Chirag Sharma - Melanoma Skin Cancer Detection using Transfer Learning with PyTorch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon/icons8-darth-vader-512.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Chirag Sharma</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../portfolio.html" rel="" target="">
 <span class="menu-text">Portfolio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume/Chirag_Sharma_Resume.pdf" rel="" target="">
 <span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Chirag1994" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://medium.com/@chirag.sharma0378" rel="" target=""><i class="bi bi-medium" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/chiragsharma1994/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <h1 class="title">Melanoma Skin Cancer Detection using Transfer Learning with PyTorch</h1>
                  <div>
        <div class="description">
          In this post, we’ll demonstrate how to scape data from flipkart using BeautifulSoup &amp; Selenium using Python.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Computer Vision</div>
                <div class="quarto-category">Deep Learning</div>
                <div class="quarto-category">PyTorch</div>
                <div class="quarto-category">Gradio</div>
                <div class="quarto-category">HuggingFace Spaces</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Chirag Sharma </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 9, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#creating-directories-to-store-python-scripts-and-model" id="toc-creating-directories-to-store-python-scripts-and-model" class="nav-link active" data-scroll-target="#creating-directories-to-store-python-scripts-and-model">Creating Directories to store python scripts and model</a></li>
  <li><a href="#creating-python-modules-in-scripts-for-training-and-prediction" id="toc-creating-python-modules-in-scripts-for-training-and-prediction" class="nav-link" data-scroll-target="#creating-python-modules-in-scripts-for-training-and-prediction">Creating Python modules in Scripts for training and prediction</a></li>
  <li><a href="#creating-requirements.txt-file-to-install-all-the-packages-for-our-model-training" id="toc-creating-requirements.txt-file-to-install-all-the-packages-for-our-model-training" class="nav-link" data-scroll-target="#creating-requirements.txt-file-to-install-all-the-packages-for-our-model-training">Creating requirements.txt file to install all the packages for our model training</a></li>
  <li><a href="#installing-all-the-packages" id="toc-installing-all-the-packages" class="nav-link" data-scroll-target="#installing-all-the-packages">Installing all the packages</a></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory Data Analysis</a></li>
  <li><a href="#patient-id" id="toc-patient-id" class="nav-link" data-scroll-target="#patient-id">Patient ID</a></li>
  <li><a href="#gender" id="toc-gender" class="nav-link" data-scroll-target="#gender">Gender</a></li>
  <li><a href="#age" id="toc-age" class="nav-link" data-scroll-target="#age">Age</a></li>
  <li><a href="#anatom_site_general_challenge" id="toc-anatom_site_general_challenge" class="nav-link" data-scroll-target="#anatom_site_general_challenge">anatom_site_general_challenge</a></li>
  <li><a href="#target" id="toc-target" class="nav-link" data-scroll-target="#target">Target</a></li>
  <li><a href="#sex-vs.-target-anatom_site_general_challenge-vs.-target" id="toc-sex-vs.-target-anatom_site_general_challenge-vs.-target" class="nav-link" data-scroll-target="#sex-vs.-target-anatom_site_general_challenge-vs.-target">Sex Vs. Target &amp; anatom_site_general_challenge Vs. Target</a></li>
  <li><a href="#age-vs.-target" id="toc-age-vs.-target" class="nav-link" data-scroll-target="#age-vs.-target">Age Vs. Target</a></li>
  <li><a href="#training-our-model-with-no-tabular-features" id="toc-training-our-model-with-no-tabular-features" class="nav-link" data-scroll-target="#training-our-model-with-no-tabular-features">Training our model with No Tabular features</a></li>
  <li><a href="#generating-submission-file-on-the-test-dataset" id="toc-generating-submission-file-on-the-test-dataset" class="nav-link" data-scroll-target="#generating-submission-file-on-the-test-dataset">Generating submission file on the test dataset</a></li>
  <li><a href="#building-gradio-demo" id="toc-building-gradio-demo" class="nav-link" data-scroll-target="#building-gradio-demo">Building Gradio demo</a>
  <ul class="collapse">
  <li><a href="#gradio-overview" id="toc-gradio-overview" class="nav-link" data-scroll-target="#gradio-overview">Gradio Overview</a></li>
  </ul></li>
  <li><a href="#creating-a-model-instance-and-putting-it-on-the-cpu" id="toc-creating-a-model-instance-and-putting-it-on-the-cpu" class="nav-link" data-scroll-target="#creating-a-model-instance-and-putting-it-on-the-cpu">Creating a model instance and putting it on the CPU</a></li>
  <li><a href="#creating-a-function-to-predict-on-a-single-images" id="toc-creating-a-function-to-predict-on-a-single-images" class="nav-link" data-scroll-target="#creating-a-function-to-predict-on-a-single-images">Creating a function to predict on a single images</a>
  <ul class="collapse">
  <li><a href="#creating-a-list-of-example-images" id="toc-creating-a-list-of-example-images" class="nav-link" data-scroll-target="#creating-a-list-of-example-images">Creating a list of example images</a></li>
  <li><a href="#building-a-gradio-interface" id="toc-building-a-gradio-interface" class="nav-link" data-scroll-target="#building-a-gradio-interface">Building a Gradio interface</a></li>
  </ul></li>
  <li><a href="#turning-our-melanoma-skin-cancer-detection-gradio-demo-into-a-deployable-app" id="toc-turning-our-melanoma-skin-cancer-detection-gradio-demo-into-a-deployable-app" class="nav-link" data-scroll-target="#turning-our-melanoma-skin-cancer-detection-gradio-demo-into-a-deployable-app">Turning our Melanoma skin cancer detection Gradio Demo into a deployable app</a>
  <ul class="collapse">
  <li><a href="#deployed-gradio-app-structure" id="toc-deployed-gradio-app-structure" class="nav-link" data-scroll-target="#deployed-gradio-app-structure">Deployed Gradio App Structure</a></li>
  <li><a href="#creating-a-demo-folder-to-store-our-melanoma-skin-cancer-app-files" id="toc-creating-a-demo-folder-to-store-our-melanoma-skin-cancer-app-files" class="nav-link" data-scroll-target="#creating-a-demo-folder-to-store-our-melanoma-skin-cancer-app-files">Creating a demo folder to store our Melanoma skin cancer App files</a></li>
  <li><a href="#creating-a-folder-of-example-images-to-use-with-our-melanoma-skin-cancer-demo" id="toc-creating-a-folder-of-example-images-to-use-with-our-melanoma-skin-cancer-demo" class="nav-link" data-scroll-target="#creating-a-folder-of-example-images-to-use-with-our-melanoma-skin-cancer-demo">Creating a folder of example images to use with our Melanoma skin cancer demo</a></li>
  <li><a href="#moving-our-trained-efficientnet-b5-model-into-our-melanoma-demo-directory." id="toc-moving-our-trained-efficientnet-b5-model-into-our-melanoma-demo-directory." class="nav-link" data-scroll-target="#moving-our-trained-efficientnet-b5-model-into-our-melanoma-demo-directory.">Moving our trained EfficientNet-B5 model into our Melanoma demo directory.</a></li>
  <li><a href="#turning-our-efficientnet-b5-model-into-a-python-script-model.py" id="toc-turning-our-efficientnet-b5-model-into-a-python-script-model.py" class="nav-link" data-scroll-target="#turning-our-efficientnet-b5-model-into-a-python-script-model.py">Turning our EfficientNet-B5 model into a Python script (<code>model.py</code>)</a></li>
  <li><a href="#turning-our-melanoma-skin-cancer-gradio-app-into-a-python-script-app.py" id="toc-turning-our-melanoma-skin-cancer-gradio-app-into-a-python-script-app.py" class="nav-link" data-scroll-target="#turning-our-melanoma-skin-cancer-gradio-app-into-a-python-script-app.py">Turning our Melanoma Skin Cancer Gradio App into a Python Script (<code>app.py</code>)</a></li>
  <li><a href="#creating-a-requirements.txt-file-for-our-gradio-apprequirements.txt" id="toc-creating-a-requirements.txt-file-for-our-gradio-apprequirements.txt" class="nav-link" data-scroll-target="#creating-a-requirements.txt-file-for-our-gradio-apprequirements.txt">Creating a requirements.txt file for our Gradio App(<code>requirements.txt</code>)</a></li>
  </ul></li>
  <li><a href="#deploying-our-application-to-huggingface-spaces" id="toc-deploying-our-application-to-huggingface-spaces" class="nav-link" data-scroll-target="#deploying-our-application-to-huggingface-spaces">Deploying our Application to HuggingFace Spaces</a>
  <ul class="collapse">
  <li><a href="#running-our-application-locally" id="toc-running-our-application-locally" class="nav-link" data-scroll-target="#running-our-application-locally">Running our Application locally</a></li>
  <li><a href="#uploading-to-hugging-face" id="toc-uploading-to-hugging-face" class="nav-link" data-scroll-target="#uploading-to-hugging-face">Uploading to Hugging Face</a></li>
  </ul></li>
  <li><a href="#our-final-application-deployed-on-huggingface-spaces" id="toc-our-final-application-deployed-on-huggingface-spaces" class="nav-link" data-scroll-target="#our-final-application-deployed-on-huggingface-spaces">Our Final Application deployed on HuggingFace Spaces</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">




<section id="creating-directories-to-store-python-scripts-and-model" class="level2">
<h2 class="anchored" data-anchor-id="creating-directories-to-store-python-scripts-and-model">Creating Directories to store python scripts and model</h2>
<p>We will first create 2 empty folders - <code>Sripts</code> (this will contain all the python modules for the trainig, validation &amp; testing the model etc.) and <code>Models</code> (which will contain model checkpoint)</p>
<p>Note that we are running this notebook from this stage in kaggle kernel. To build/Replicate the model, follow the exact same steps mentioned in the notebook.</p>
<p>We first build our model in kaggle kernel because of the free computational resources, one can use google colab (free version) but it has certain limitations like it cannot handle the image size like we’ll be using in this project.</p>
<p>So we’ll utilize the <code>kaggle computation resources</code> to carry out this project.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:35.171828Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:35.171553Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:35.177220Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:35.176176Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:35.171801Z&quot;}" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">## Creating Empty folders</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>scripts_file_path <span class="op">=</span> Path(<span class="st">"Scripts"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>models_file_path <span class="op">=</span> Path(<span class="st">'Models'</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>scripts_file_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>models_file_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="creating-python-modules-in-scripts-for-training-and-prediction" class="level2">
<h2 class="anchored" data-anchor-id="creating-python-modules-in-scripts-for-training-and-prediction">Creating Python modules in Scripts for training and prediction</h2>
<p>First we will write/create python modules like for <code>augmentations</code>, <code>config</code>, <code>training &amp; validation loops</code>, <code>prediction_to_generate_on_test_dataset</code> etc.</p>
<p>For training augmentations we’ll be using like flipping the image, creating random patches in the image, randomly rotating 90 degrees, Adjusting the brightness and contrast, adding noise in the images, Shifting and sheering the image and finally normalizing the statistics of the image (since we will be using transfer learning therefore we need to prepare the images in the same way they were trained on - depending on the specific model we want to use).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:37.885318Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:37.884778Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:37.900988Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:37.899759Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:37.885275Z&quot;}" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Scripts<span class="op">/</span>augmentations.py</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.config <span class="im">import</span> Config</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> albumentations <span class="im">as</span> A</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>training_augmentations <span class="op">=</span> A.Compose(</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        A.CoarseDropout(p<span class="op">=</span><span class="fl">0.6</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        A.RandomRotate90(p<span class="op">=</span><span class="fl">0.6</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        A.Flip(p<span class="op">=</span><span class="fl">0.4</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        A.OneOf(</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                A.RandomBrightnessContrast(brightness_limit<span class="op">=</span><span class="fl">0.2</span>, contrast_limit<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                A.HueSaturationValue(</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                    hue_shift_limit<span class="op">=</span><span class="dv">20</span>, sat_shift_limit<span class="op">=</span><span class="dv">60</span>, val_shift_limit<span class="op">=</span><span class="dv">50</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>            p<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        A.OneOf([A.GaussianBlur(), A.GaussNoise()], p<span class="op">=</span><span class="fl">0.65</span>),</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        A.ShiftScaleRotate(</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>            shift_limit<span class="op">=</span><span class="fl">0.0625</span>, scale_limit<span class="op">=</span><span class="fl">0.35</span>, rotate_limit<span class="op">=</span><span class="dv">45</span>, p<span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        A.OneOf(</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                A.OpticalDistortion(p<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                A.GridDistortion(p<span class="op">=</span><span class="fl">0.1</span>),</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                A.PiecewiseAffine(p<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            p<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        A.Normalize(</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            mean<span class="op">=</span>Config.MEAN, std<span class="op">=</span>Config.STD, max_pixel_value<span class="op">=</span><span class="fl">255.0</span>, always_apply<span class="op">=</span><span class="va">True</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>validation_augmentations <span class="op">=</span> A.Compose(</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        A.Normalize(</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>            mean<span class="op">=</span>Config.MEAN, std<span class="op">=</span>Config.STD, max_pixel_value<span class="op">=</span><span class="fl">255.0</span>, always_apply<span class="op">=</span><span class="va">True</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>testing_augmentations <span class="op">=</span> A.Compose(</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        A.Normalize(</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>            mean<span class="op">=</span>Config.MEAN, std<span class="op">=</span>Config.STD, max_pixel_value<span class="op">=</span><span class="fl">255.0</span>, always_apply<span class="op">=</span><span class="va">True</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing Scripts/augmentations.py</code></pre>
</div>
</div>
<p>Creating a config module which will contain model configurations like number of epochs to run, size of an image, weight decay (for regularization) etc., it also contains the path of the files and folders of the data.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:39.191139Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:39.190594Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:39.200175Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:39.198628Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:39.191091Z&quot;}" data-execution_count="4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Scripts<span class="op">/</span>config.py</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Config:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    EPOCHS <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    IMG_SIZE <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    ES_PATIENCE <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    WEIGHT_DECAY <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    VAL_BATCH_SIZE <span class="op">=</span> <span class="dv">32</span> <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    RANDOM_STATE <span class="op">=</span> <span class="dv">1994</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    LEARNING_RATE <span class="op">=</span> <span class="fl">5e-5</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    TRAIN_BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    MEAN <span class="op">=</span> (<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    STD <span class="op">=</span> (<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    TRAIN_COLS <span class="op">=</span> [</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image_name"</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"patient_id"</span>,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sex"</span>,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age_approx"</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"anatom_site_general_challenge"</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"target"</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tfrecord"</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    TEST_COLS <span class="op">=</span> [</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image_name"</span>,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"patient_id"</span>,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sex"</span>,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age_approx"</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"anatom_site_general_challenge"</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    DEVICE <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">################ Setting paths to data input ################</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    data_2020 <span class="op">=</span> <span class="st">"../input/jpeg-melanoma-512x512/"</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    train_folder_2020 <span class="op">=</span> data_2020 <span class="op">+</span> <span class="st">"train/"</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    test_folder_2020 <span class="op">=</span> data_2020 <span class="op">+</span> <span class="st">"test/"</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    test_csv_path_2020 <span class="op">=</span> data_2020 <span class="op">+</span> <span class="st">"test.csv"</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    train_csv_path_2020 <span class="op">=</span> data_2020 <span class="op">+</span> <span class="st">"train.csv"</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    submission_csv_path <span class="op">=</span> data_2020 <span class="op">+</span> <span class="st">"sample_submission.csv"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing Scripts/config.py</code></pre>
</div>
</div>
<p>Creating a single dataset class to read the images (both training, validation &amp; testing images), the function is capable of handling/reading the tabular features.</p>
<p>The function takes a dataframe, a list of tabular features (if we want to use for training) i.e., list of strings like <code>['sex_missing',anatom_site_general_challenge_head_neck','anatom_site_general_challenge_lower_extremity',     anatom_site_general_challenge_torso','anatom_site_general_challenge_upper_extremity','scaled_age']</code> , the augmentations we want to use and finally whether the dataset is a training, validation or testing dataset.</p>
<p>For training and validation we set <code>is_test=False</code> and for testing we set <code>is_test=True</code> to differentiate between the datasets.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:39.608453Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:39.607345Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:39.617169Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:39.615839Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:39.608402Z&quot;}" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Scripts<span class="op">/</span>dataset.py</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> ImageFile</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Callable</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>ImageFile.LOAD_TRUNCATED_IMAGES <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DatasetRetriever(nn.Module):</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Dataset class to read the images and tabular features from a</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">    dataframe and returns the dictionary.</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        df: pd.DataFrame,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        tabular_features: List[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        use_tabular_features: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        augmentations: Callable <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        is_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" """</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.df <span class="op">=</span> df</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tabular_features <span class="op">=</span> tabular_features</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_tabular_features <span class="op">=</span> use_tabular_features</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.augmentations <span class="op">=</span> augmentations</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.is_test <span class="op">=</span> is_test</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co">        Function returns the number of images in a dataframe.</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.df)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, index):</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="co">        Function the takes an images and it's corresponding</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="co">        tabular/meta features &amp; target feature (for training</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="co">        and validation) and returns a dictionary, otherwise,</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="co">        for test dataset it only returns a dictionary of</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="co">        an image and tabular features.</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        image_path <span class="op">=</span> <span class="va">self</span>.df[<span class="st">"image_path"</span>].iloc[index]</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> Image.<span class="bu">open</span>(image_path)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> np.array(image)</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.augmentations <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>            augmented <span class="op">=</span> <span class="va">self</span>.augmentations(image<span class="op">=</span>image)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>            image <span class="op">=</span> augmented[<span class="st">"image"</span>]</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> np.transpose(image, (<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)).astype(np.float32)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> torch.tensor(image, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.use_tabular_features:</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(<span class="va">self</span>.tabular_features) <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">self</span>.is_test <span class="kw">is</span> <span class="va">False</span>:</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>                tabular_features <span class="op">=</span> np.array(</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.df.iloc[index][<span class="va">self</span>.tabular_features].values, dtype<span class="op">=</span>np.float32</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>                targets <span class="op">=</span> <span class="va">self</span>.df.target[index]</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> {</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"image"</span>: image,</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"tabular_features"</span>: tabular_features,</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"targets"</span>: torch.tensor(targets, dtype<span class="op">=</span>torch.<span class="bu">long</span>),</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="bu">len</span>(<span class="va">self</span>.tabular_features) <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">self</span>.is_test <span class="kw">is</span> <span class="va">True</span>:</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>                tabular_features <span class="op">=</span> np.array(</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.df.iloc[index][<span class="va">self</span>.tabular_features].values, dtype<span class="op">=</span>np.float32</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> {<span class="st">"image"</span>: image, <span class="st">"tabular_features"</span>: tabular_features}</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.is_test <span class="kw">is</span> <span class="va">False</span>:</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>                targets <span class="op">=</span> <span class="va">self</span>.df.target[index]</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> {</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"image"</span>: image,</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"targets"</span>: torch.tensor(targets, dtype<span class="op">=</span>torch.<span class="bu">long</span>),</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="va">self</span>.is_test <span class="kw">is</span> <span class="va">True</span>:</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> {<span class="st">"image"</span>: image}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing Scripts/dataset.py</code></pre>
</div>
</div>
<p>Now we create a model class to create a model instance of EfficientNet model.</p>
<p>Currently, this function is capable of reading the images only and not the tabular features.</p>
<p>Since in this project/notebook we are using the images only therefore, this function is good enough for that.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:40.027120Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:40.026720Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:40.036094Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:40.034812Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:40.027083Z&quot;}" data-execution_count="6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Scripts<span class="op">/</span>model.py</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> efficientnet_pytorch <span class="im">import</span> EfficientNet</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> efficientnet_pytorch <span class="im">import</span> EfficientNet</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Class to instantiate EfficientNet-b5 model object which only</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">    used images as inputs.</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_name<span class="op">=</span><span class="st">"efficientnet-b5"</span>, pool_type<span class="op">=</span>F.adaptive_avg_pool2d):</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pool_type <span class="op">=</span> pool_type</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_name <span class="op">=</span> model_name</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.backbone <span class="op">=</span> EfficientNet.from_pretrained(model_name)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        in_features <span class="op">=</span> <span class="bu">getattr</span>(<span class="va">self</span>.backbone, <span class="st">"_fc"</span>).in_features</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.classifier <span class="op">=</span> nn.Linear(in_features, <span class="dv">1</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> <span class="va">self</span>.pool_type(<span class="va">self</span>.backbone.extract_features(x), <span class="dv">1</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> features.view(x.size(<span class="dv">0</span>), <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.classifier(features)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co"># class Model(nn.Module):</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     """</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">#     Class to instantiate EfficientNet-b5 model object which uses images</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co">#     as well as tabular features as inputs.</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co">#     """</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     def __init__(self, model_name='efficientnet-b5', pool_type=F.adaptive_avg_pool2d,</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co">#                 num_tabular_features=0):</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="co">#         super().__init__()</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co">#         self.pool_type = pool_type</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="co">#         self.model_name = model_name</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="co">#         self.backbone = EfficientNet.from_pretrained(model_name)</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="co">#         in_features = getattr(self.backbone, "_fc").in_features</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="co">#         if num_tabular_features&gt;0:</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="co">#             self.meta = nn.Sequential(</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="co">#                 nn.Linear(num_tabular_features, 512),</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="co">#                 nn.BatchNorm1d(512),</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span class="co">#                 nn.ReLU(),</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="co">#                 nn.Dropout(p=0.5),</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="co">#                 nn.Linear(512, 128),</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="co">#                 nn.BatchNorm1d(128),</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="co">#                 nn.ReLU())</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="co">#             in_features += 128</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="co">#         self.output = nn.Linear(in_features, 1)</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="co">#     def forward(self, image, tabular_features=None):</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="co">#         features = self.pool_type(self.backbone.extract_features(image), 1)</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co">#         cnn_features = features.view(image.size(0),-1)</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="co">#         if num_tabular_features&gt;0:</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="co">#             tabular_features = self.meta(tabular_features)</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="co">#             all_features = torch.cat((cnn_features, tabular_features), dim=1)</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="co">#             output = self.output(all_features)</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="co">#             return output</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="co">#         else:</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a><span class="co">#             output = self.output(cnn_features)</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="co">#             return output</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing Scripts/model.py</code></pre>
</div>
</div>
<p>We create a validation function that predicts and generates probabilities only on the validation corresponding to a specific fold.</p>
<p>This function might be useful in come cases. This function is capable of running on a single gpu or multi-gpu device as well as on cpu.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:40.387089Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:40.386397Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:40.395297Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:40.394081Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:40.387050Z&quot;}" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Scripts<span class="op">/</span>predict_on_validation_data.py</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.config <span class="im">import</span> Config</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.model <span class="im">import</span> Model</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.dataset <span class="im">import</span> DatasetRetriever</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.augmentations <span class="im">import</span> validation_augmentations</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_on_validation_dataset(</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    validation_df: pd.DataFrame, model_path: <span class="bu">str</span>, use_tabular_features: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">    This function generates prediction probabilities on the</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co">    validation dataset and returns a submission.csv file.</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co">        validation_dataset = validation_dataframe.</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co">        model_path = location where model state_dict is located.</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co">        use_tabular_features: whether to use the tabular features</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co">        or not.</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    valid_dataset <span class="op">=</span> DatasetRetriever(</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        df<span class="op">=</span>validation_df,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        tabular_features<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        use_tabular_features<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        augmentations<span class="op">=</span>validation_augmentations,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        is_test<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    valid_dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        dataset<span class="op">=</span>valid_dataset,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>Config.VAL_BATCH_SIZE,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        shuffle<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        num_workers<span class="op">=</span>os.cpu_count(),</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    valid_predictions <span class="op">=</span> []</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.cuda.device_count() <span class="kw">in</span> (<span class="dv">0</span>, <span class="dv">1</span>):</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> Model().to(</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            Config.DEVICE</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> torch.cuda.device_count() <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> Model().to(</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>            Config.DEVICE</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> nn.DataParallel(model)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    model.load_state_dict(torch.load(model_path))</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.inference_mode():</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, data <span class="kw">in</span> <span class="bu">enumerate</span>(valid_dataloader):</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> use_tabular_features:</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>                data[<span class="st">"image"</span>], data[<span class="st">"tabular_features"</span>] <span class="op">=</span> data[<span class="st">"image"</span>].to(</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>                    Config.DEVICE, dtype<span class="op">=</span>torch.<span class="bu">float</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>                ), data[<span class="st">"tabular_features"</span>].to(Config.DEVICE, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>                y_logits <span class="op">=</span> model(data[<span class="st">"image"</span>], data[<span class="st">"tabular_features"</span>])</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>                data[<span class="st">"image"</span>] <span class="op">=</span> data[<span class="st">"image"</span>].to(Config.DEVICE, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>                y_logits <span class="op">=</span> model(data[<span class="st">"image"</span>]).squeeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>            valid_probs <span class="op">=</span> torch.sigmoid(y_logits).detach().cpu().numpy()</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>            valid_predictions.extend(valid_probs)</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>    valid_predictions <span class="op">=</span> [</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>        valid_predictions[img].item() <span class="cf">for</span> img <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(valid_predictions))</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> valid_predictions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing Scripts/predict_on_validation_data.py</code></pre>
</div>
</div>
<p>This below function is used to generate the prediction probabilities on the testing dataset provided for the competition and generates a submission.csv file for the public and private leaderboard results.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:40.762800Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:40.761623Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:40.771018Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:40.769589Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:40.762750Z&quot;}" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Scripts<span class="op">/</span>predict_on_test.py</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.config <span class="im">import</span> Config</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.model <span class="im">import</span> Model</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.dataset <span class="im">import</span> DatasetRetriever</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.augmentations <span class="im">import</span> testing_augmentations</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_on_test_and_generate_submission_file(</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    test_df: pd.DataFrame, model_path: <span class="bu">str</span>, use_tabular_features: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">    This function generates prediction probabilities on the</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">    test dataset and returns a submission.csv file.</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co">        test_df = test_dataframe.</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co">        model_path = location where model state_dict is located.</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co">        use_tabular_features: whether to use the tabular features</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co">        or not.</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    test_dataset <span class="op">=</span> DatasetRetriever(</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        df<span class="op">=</span>test_df,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        tabular_features<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        use_tabular_features<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        augmentations<span class="op">=</span>testing_augmentations,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        is_test<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    test_dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>        dataset<span class="op">=</span>test_dataset,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>Config.VAL_BATCH_SIZE,</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        shuffle<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        num_workers<span class="op">=</span>os.cpu_count(),</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    test_predictions <span class="op">=</span> []</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.cuda.device_count() <span class="kw">in</span> (<span class="dv">0</span>, <span class="dv">1</span>):</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> Model().to(</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            Config.DEVICE</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> torch.cuda.device_count() <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> Model().to(</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>            Config.DEVICE</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> nn.DataParallel(model)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    model.load_state_dict(torch.load(model_path))</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.inference_mode():</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, data <span class="kw">in</span> <span class="bu">enumerate</span>(test_dataloader):</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> use_tabular_features:</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>                data[<span class="st">"image"</span>], data[<span class="st">"tabular_features"</span>] <span class="op">=</span> data[<span class="st">"image"</span>].to(</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>                    Config.DEVICE, dtype<span class="op">=</span>torch.<span class="bu">float</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>                ), data[<span class="st">"tabular_features"</span>].to(Config.DEVICE, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>                y_logits <span class="op">=</span> model(data[<span class="st">"image"</span>], data[<span class="st">"tabular_features"</span>])</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>                data[<span class="st">"image"</span>] <span class="op">=</span> data[<span class="st">"image"</span>].to(Config.DEVICE, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>                y_logits <span class="op">=</span> model(data[<span class="st">"image"</span>]).squeeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>            test_probs <span class="op">=</span> torch.sigmoid(y_logits).detach().cpu().numpy()</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>            test_predictions.extend(test_probs)</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    submission_df <span class="op">=</span> pd.read_csv(Config.submission_csv_path)</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    test_predictions <span class="op">=</span> [</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>        test_predictions[img].item() <span class="cf">for</span> img <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(test_predictions))</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    submission_df[<span class="st">"target"</span>] <span class="op">=</span> test_predictions</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>    submission_df.to_csv(<span class="st">"../working/submission.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing Scripts/predict_on_test.py</code></pre>
</div>
</div>
<p>Now, we create a <code>train_model</code> module which has a run_model function that takes a <code>fold number</code> and the <code>training dataframe</code>.</p>
<p>The function creates training and validation dataframe , then we create training and validation datasets which only <code>reads images</code> and <code>no tabular features</code>, next we initialize seed (for reproduciblity of results), <code>model object</code>, <code>loss function</code>, <code>optimizer</code>, <code>scheduler</code> and a <code>scaler object (for mixed precision)</code>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:41.097229Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:41.096768Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:41.106320Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:41.105018Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:41.097188Z&quot;}" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Scripts<span class="op">/</span>train_model.py</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.config <span class="im">import</span> Config</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.model <span class="im">import</span> Model</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.cuda.amp <span class="im">as</span> amp</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.utils <span class="im">import</span> create_folds</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.utils <span class="im">import</span> seed_everything</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.dataset <span class="im">import</span> DatasetRetriever</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> default_timer <span class="im">as</span> timer</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.training_and_validation_loops <span class="im">import</span> train</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.augmentations <span class="im">import</span> training_augmentations, validation_augmentations</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_model(fold, train_df):</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    train_df <span class="op">=</span> create_folds(train_df<span class="op">=</span>train_df)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    train_data <span class="op">=</span> train_df.loc[train_df[<span class="st">"fold"</span>] <span class="op">!=</span> fold].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    valid_data <span class="op">=</span> train_df.loc[train_df[<span class="st">"fold"</span>] <span class="op">==</span> fold].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    validation_targets <span class="op">=</span> valid_data[<span class="st">"target"</span>]</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    train_dataset <span class="op">=</span> DatasetRetriever(</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        df<span class="op">=</span>train_data,</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        tabular_features<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        use_tabular_features<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        augmentations<span class="op">=</span>training_augmentations,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        is_test<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    valid_dataset <span class="op">=</span> DatasetRetriever(</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        df<span class="op">=</span>valid_data,</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>        tabular_features<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        use_tabular_features<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>        augmentations<span class="op">=</span>validation_augmentations,</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>        is_test<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    training_dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>        dataset<span class="op">=</span>train_dataset,</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>Config.TRAIN_BATCH_SIZE,</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        num_workers<span class="op">=</span>os.cpu_count(),</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    validation_dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        dataset<span class="op">=</span>valid_dataset,</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>Config.VAL_BATCH_SIZE,</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>        shuffle<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>        num_workers<span class="op">=</span>os.cpu_count(),</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    seed_everything(Config.RANDOM_STATE)</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.cuda.device_count() <span class="kw">in</span> (<span class="dv">0</span>, <span class="dv">1</span>):</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> Model().to(</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>            Config.DEVICE</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> torch.cuda.device_count() <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> Model().to(</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>            Config.DEVICE</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> nn.DataParallel(model)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> nn.BCEWithLogitsLoss()</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.AdamW(</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>        params<span class="op">=</span>model.parameters(),</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>        lr<span class="op">=</span>Config.LEARNING_RATE,</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>        weight_decay<span class="op">=</span>Config.WEIGHT_DECAY,</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    scheduler <span class="op">=</span> torch.optim.lr_scheduler.ReduceLROnPlateau(</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>optimizer,</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>        mode<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>        factor<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>        patience<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>        threshold<span class="op">=</span><span class="fl">1e-3</span>,</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> amp.GradScaler()</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> timer()</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    model_save_path <span class="op">=</span> <span class="ss">f"../working/Models/efficientnet_b5_checkpoint_fold_</span><span class="sc">{</span>fold<span class="sc">}</span><span class="ss">.pt"</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    model_results <span class="op">=</span> train(</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model,</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>        train_dataloader<span class="op">=</span>training_dataloader,</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>        valid_dataloader<span class="op">=</span>validation_dataloader,</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>        loss_fn<span class="op">=</span>loss,</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>optimizer,</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>        scheduler<span class="op">=</span>scheduler,</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>        device<span class="op">=</span>Config.DEVICE,</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>        scaler<span class="op">=</span>scaler,</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span>Config.EPOCHS,</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>        es_patience<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>        model_save_path<span class="op">=</span>model_save_path,</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>        validation_targets<span class="op">=</span>validation_targets,</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    end_time <span class="op">=</span> timer()</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total training time: </span><span class="sc">{</span>end_time<span class="op">-</span>start_time<span class="sc">:.3f}</span><span class="ss"> seconds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing Scripts/train_model.py</code></pre>
</div>
</div>
<p>Regular <code>pytorch training and validation loops</code> epochs for a single epoch and finally for <code>N</code> number of epochs a <code>train function.</code></p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:42.260540Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:42.260074Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:42.272131Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:42.270755Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:42.260506Z&quot;}" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Scripts<span class="op">/</span>training_and_validation_loops.py</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.cuda.amp <span class="im">as</span> amp</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.utils <span class="im">import</span> EarlyStopping</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_auc_score</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_one_epoch(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    model, dataloader, loss_fn, optimizer, device, scaler, use_tabular_features<span class="op">=</span><span class="va">False</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Function takes a model instance, dataloader, loss function, an optimizer, device</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">    (on which device should you want to run the model on i.e., GPU or CPU)</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">    , scaler (for mixed precision) and whether to use tabular features or not.</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">    This function runs/passes the images and tabular features for a single epoch</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">    and returns the loss value on training dataset.</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    train_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> data <span class="kw">in</span> dataloader:</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_tabular_features:</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>            data[<span class="st">"image"</span>], data[<span class="st">"tabular_features"</span>], data[<span class="st">"targets"</span>] <span class="op">=</span> (</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                data[<span class="st">"image"</span>].to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>),</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                data[<span class="st">"tabular_features"</span>].to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>),</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                data[<span class="st">"targets"</span>].to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>),</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> amp.autocast():</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>                y_logits <span class="op">=</span> model(data[<span class="st">"image"</span>], data[<span class="st">"tabular_features"</span>]).squeeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> loss_fn(y_logits, data[<span class="st">"targets"</span>].view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>            data[<span class="st">"image"</span>], data[<span class="st">"targets"</span>] <span class="op">=</span> data[<span class="st">"image"</span>].to(</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>                device, dtype<span class="op">=</span>torch.<span class="bu">float</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>            ), data[<span class="st">"targets"</span>].to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> amp.autocast():</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>                y_logits <span class="op">=</span> model(data[<span class="st">"image"</span>]).squeeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> loss_fn(y_logits, data[<span class="st">"targets"</span>].view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">+=</span> loss.item()</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>        scaler.scale(loss).backward()</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>        scaler.step(optimizer)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>        scaler.update()</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    train_loss <span class="op">=</span> train_loss <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_loss</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_one_epoch(model, dataloader, loss_fn, device, use_tabular_features<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="co">    Function takes a model instance, dataloader, loss function, device</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="co">    (on which device should you want to run the model on i.e., GPU or CPU)</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="co">    and whether to use tabular features or not.</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="co">    This function runs/passes the images and tabular features for a single epoch</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a><span class="co">    and returns the loss value &amp; final predictions on the validation dataset.</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    valid_loss, final_predictions <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.inference_mode():</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> data <span class="kw">in</span> dataloader:</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> use_tabular_features:</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>                data[<span class="st">"image"</span>], data[<span class="st">"tabular_features"</span>], data[<span class="st">"targets"</span>] <span class="op">=</span> (</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>                    data[<span class="st">"image"</span>].to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>),</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>                    data[<span class="st">"tabular_features"</span>].to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>),</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>                    data[<span class="st">"targets"</span>].to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>),</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>                y_logits <span class="op">=</span> model(data[<span class="st">"image"</span>], data[<span class="st">"tabular_features"</span>]).squeeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>                data[<span class="st">"image"</span>], data[<span class="st">"targets"</span>] <span class="op">=</span> data[<span class="st">"image"</span>].to(</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>                    device, dtype<span class="op">=</span>torch.<span class="bu">float</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>                ), data[<span class="st">"targets"</span>].to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>                y_logits <span class="op">=</span> model(data[<span class="st">"image"</span>]).squeeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> loss_fn(y_logits, data[<span class="st">"targets"</span>].view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>            valid_loss <span class="op">+=</span> loss.item()</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>            valid_probs <span class="op">=</span> torch.sigmoid(y_logits).detach().cpu().numpy()</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>            final_predictions.extend(valid_probs)</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>    valid_loss <span class="op">=</span> valid_loss <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> valid_loss, final_predictions</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    train_dataloader,</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    valid_dataloader,</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>    loss_fn,</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>    optimizer,</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>    scheduler,</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>    device,</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>    scaler,</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>    epochs,</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>    es_patience,</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>    model_save_path,</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>    validation_targets,</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a><span class="co">    This function takes a model instance, training dataloader,</span></span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a><span class="co">    validation dataloader, loss_fn, optimizer, scheduler, device,</span></span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a><span class="co">    scaler (object, for mixed precision), epochs (for how many epochs</span></span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a><span class="co">    to run the model), es_patience (number of epochs to wait after which</span></span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a><span class="co">    the model should stop training), model_save_path (where to save the</span></span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a><span class="co">    model to), validation_targets (used for the calculation of the AUC</span></span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a><span class="co">    score) and returns a dictionary object which has training loss,</span></span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a><span class="co">    validation loss and validation AUC score.</span></span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {<span class="st">"train_loss"</span>: [], <span class="st">"valid_loss"</span>: [], <span class="st">"valid_auc"</span>: []}</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>    early_stopping <span class="op">=</span> EarlyStopping(</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>        patience<span class="op">=</span>es_patience, verbose<span class="op">=</span><span class="va">True</span>, path<span class="op">=</span>model_save_path</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(epochs)):</span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">=</span> train_one_epoch(</span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span>model,</span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a>            dataloader<span class="op">=</span>train_dataloader,</span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a>            loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a>            optimizer<span class="op">=</span>optimizer,</span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a>            device<span class="op">=</span>device,</span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a>            scaler<span class="op">=</span>scaler,</span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>            use_tabular_features<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>        valid_loss, valid_predictions <span class="op">=</span> validate_one_epoch(</span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span>model,</span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>            dataloader<span class="op">=</span>valid_dataloader,</span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>            loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>            device<span class="op">=</span>device,</span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>            use_tabular_features<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>        valid_predictions <span class="op">=</span> np.vstack(valid_predictions).ravel()</span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>        valid_auc <span class="op">=</span> roc_auc_score(y_score<span class="op">=</span>valid_predictions, y_true<span class="op">=</span>validation_targets)</span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>        scheduler.step(valid_auc)</span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a>        early_stopping(valid_loss, model)</span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> early_stopping.early_stop:</span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Early Stopping"</span>)</span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>        model.load_state_dict(torch.load(model_save_path))</span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(</span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Epoch : </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> | "</span></span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"train_loss : </span><span class="sc">{</span>train_loss<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"valid_loss : </span><span class="sc">{</span>valid_loss<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"valid_auc : </span><span class="sc">{</span>valid_auc<span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"train_loss"</span>].append(train_loss)</span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"valid_loss"</span>].append(valid_loss)</span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"valid_auc"</span>].append(valid_auc)</span>
<span id="cb16-150"><a href="#cb16-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing Scripts/training_and_validation_loops.py</code></pre>
</div>
</div>
<p>In the utils module we write some useful functions like <code>create_folds</code> (which will divide the training dataset into 5 equal parts and remove duplicate images from the dataset)</p>
<p><code>seed_everything</code> (for reproducing the results)</p>
<p><code>EarlyStopping</code> class (used to stop model training if our model performance on validation dataset starts to decline), plot_loss_curves (for plotting the training and validation loss and auc_scores for each epoch)</p>
<p><code>RareLabelCategoryEncoder</code> (class that combines the category/categories of a feature that appears in the dataset for a certain percentage of times like 5% of the time etc. into a single category called Rare)</p>
<p><code>OutlierTreatment</code> (class to cap the values of a feature by learning the lower quantile and upper_quantile values of a feature from the dataset (X) in the fit method and caps(transforms) the feature values in the dataset (x) passed in the transformed method).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:42.593420Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:42.593062Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:42.603972Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:42.602713Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:42.593385Z&quot;}" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Scripts<span class="op">/</span>utils.py</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_folds(train_df):</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Function that folds in the training data and removes duplicate</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">    images from the training data.</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    train_df <span class="op">=</span> train_df.loc[train_df[<span class="st">"tfrecord"</span>] <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span>].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    train_df[<span class="st">"fold"</span>] <span class="op">=</span> train_df[<span class="st">"tfrecord"</span>] <span class="op">%</span> <span class="dv">5</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_df</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> seed_everything(seed: <span class="bu">int</span>):</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Function to set seed and to make reproducible results.</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co">        seed (int): like 42</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    random.seed(seed)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    os.environ[<span class="st">"PYTHONHASHSEED"</span>] <span class="op">=</span> <span class="bu">str</span>(seed)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    torch.manual_seed(seed)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    torch.cuda.manual_seed(seed)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    torch.backends.cudnn.deterministic <span class="op">=</span> <span class="va">True</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    torch.backends.cudnn.benchmark <span class="op">=</span> <span class="va">False</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EarlyStopping:</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Early stops the training if validation loss doesn't improve after a given patience.</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="co">    Directly borrowed from https://github.com/Bjarten/early-stopping-pytorch/blob/master/pytorchtools.py</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>        path: <span class="bu">str</span>,</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        patience: <span class="bu">int</span> <span class="op">=</span> <span class="dv">7</span>,</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>        verbose: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>        delta: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span>,</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        trace_func<span class="op">=</span><span class="bu">print</span>,</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="co">            patience (int): How long to wait after last time validation loss improved.</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="co">                            Default: 7</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="co">            verbose (bool): If True, prints a message for each validation loss improvement.</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="co">                            Default: False</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a><span class="co">            delta (float): Minimum change in the monitored quantity to qualify as an improvement.</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="co">                            Default: 0</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="co">            path (str): Path for the checkpoint to be saved to.</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="co">                            Default: 'checkpoint.pt'</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a><span class="co">            trace_func (function): trace print function.</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="co">                            Default: print</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.patience <span class="op">=</span> patience</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.verbose <span class="op">=</span> verbose</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.best_score <span class="op">=</span> <span class="va">None</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.early_stop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.val_loss_min <span class="op">=</span> np.Inf</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.delta <span class="op">=</span> delta</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.path <span class="op">=</span> path</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.trace_func <span class="op">=</span> trace_func</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, val_loss, model):</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="op">-</span>val_loss</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.best_score <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.best_score <span class="op">=</span> score</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.save_checkpoint(val_loss, model)</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> score <span class="op">&lt;</span> <span class="va">self</span>.best_score <span class="op">+</span> <span class="va">self</span>.delta:</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.trace_func(</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"EarlyStopping counter: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>counter<span class="sc">}</span><span class="ss"> out of </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>patience<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.counter <span class="op">&gt;=</span> <span class="va">self</span>.patience:</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.early_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.best_score <span class="op">=</span> score</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.save_checkpoint(val_loss, model)</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save_checkpoint(<span class="va">self</span>, val_loss, model):</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Saves model when validation loss decrease."""</span></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.verbose:</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.trace_func(</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Validation loss decreased (</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>val_loss_min<span class="sc">:.6f}</span><span class="ss"> --&gt; </span><span class="sc">{</span>val_loss<span class="sc">:.6f}</span><span class="ss">).  Saving model ..."</span></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>        torch.save(obj<span class="op">=</span>model.state_dict(), f<span class="op">=</span><span class="va">self</span>.path)</span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.val_loss_min <span class="op">=</span> val_loss</span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_loss_curves(results: <span class="bu">dict</span>):</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a><span class="co">    Function to plot training &amp; validation loss curves &amp; validation AUC</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a><span class="co">        results (dict): A dictionary of training loss, validation_loss &amp;</span></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a><span class="co">        validation AUC score.</span></span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> results[<span class="st">"train_loss"</span>]</span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a>    valid_loss <span class="op">=</span> results[<span class="st">"valid_loss"</span>]</span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the accuracy values of the results dictionary (training and test)</span></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a>    valid_auc <span class="op">=</span> results[<span class="st">"valid_auc"</span>]</span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Figure out how many epochs there were</span></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a>    epochs <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(results[<span class="st">"train_loss"</span>]))</span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup a plot</span></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">7</span>))</span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot loss</span></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a>    plt.plot(epochs, loss, label<span class="op">=</span><span class="st">"train_loss"</span>)</span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a>    plt.plot(epochs, valid_loss, label<span class="op">=</span><span class="st">"valid_loss"</span>)</span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Loss"</span>)</span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Epochs"</span>)</span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot accuracy</span></span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a>    plt.plot(epochs, valid_auc, label<span class="op">=</span><span class="st">"valid_auc"</span>)</span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"AUC Score"</span>)</span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Epochs"</span>)</span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RareLabelCategoryEncoder(BaseEstimator, TransformerMixin):</span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a><span class="co">    Class to combine rare categories of a categorical variable</span></span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a><span class="co">    where a category appearing less than a certain percentage</span></span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a><span class="co">    (as a threshold).</span></span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a><span class="co">    Example: a category/categories appearing less than 5% of the</span></span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a><span class="co">    times are combined a single category called rare.</span></span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, variables: List, tol<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a><span class="co">            variables (List): A list of variables for which we want</span></span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a><span class="co">            to combine into rare categories.</span></span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a><span class="co">            tol (int): A Threshold/Tolerance below which we want to</span></span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a><span class="co">            consider a category of a feature as rare.</span></span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(variables, <span class="bu">list</span>):</span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Variables should be a list"</span>)</span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tol <span class="op">=</span> tol</span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.variables <span class="op">=</span> variables</span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, x: pd.DataFrame):</span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a><span class="co">        This function learns all the values/categories &amp; the</span></span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a><span class="co">        percentage of times it appears in a feature in the</span></span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a><span class="co">        dataset passed while using this method.</span></span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a><span class="co">            X : From this dataset the fit function learns and</span></span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a><span class="co">            stores the number of times a category appears in</span></span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a><span class="co">            the dataset</span></span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoder_dict_ <span class="op">=</span> {}</span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> <span class="va">self</span>.variables:</span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> pd.Series(x[var]).value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.encoder_dict_[var] <span class="op">=</span> <span class="bu">list</span>(t[t <span class="op">&gt;=</span> <span class="va">self</span>.tol].index)</span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, x: pd.DataFrame):</span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a><span class="co">        X (pd.DataFrame): Transform/Combines the categories of each</span></span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a><span class="co">        features passed into the variables list on the dataset passed</span></span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a><span class="co">        in this method and returns the transformed dataset.</span></span>
<span id="cb18-175"><a href="#cb18-175" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb18-176"><a href="#cb18-176" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x.copy()</span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> <span class="va">self</span>.variables:</span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a>            x[var] <span class="op">=</span> np.where(x[var].isin(<span class="va">self</span>.encoder_dict_[var]), x[var], <span class="st">"Other"</span>)</span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OutlierTreatment(BaseEstimator, TransformerMixin):</span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a><span class="co">    Class to handle outliers in a continous feature.</span></span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-187"><a href="#cb18-187" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb18-188"><a href="#cb18-188" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, variable: <span class="bu">str</span>, upper_quantile: <span class="bu">float</span> <span class="op">=</span> <span class="va">None</span>, lower_quantile: <span class="bu">float</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb18-190"><a href="#cb18-190" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb18-191"><a href="#cb18-191" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a><span class="co">            variables (str): A variable to cap the upper and</span></span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a><span class="co">            lower boundaries of.</span></span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a><span class="co">            upper_quantile (float): A maximum value beyond which all the</span></span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a><span class="co">            values of a feature are capped at.</span></span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a><span class="co">            lower_quantile (float): A minimum value that are lower than</span></span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a><span class="co">            of the feature are capped at.</span></span>
<span id="cb18-198"><a href="#cb18-198" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb18-199"><a href="#cb18-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(variable, <span class="bu">str</span>):</span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Variable should be a string type."</span>)</span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.upper_quantile <span class="op">=</span> upper_quantile</span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.variable <span class="op">=</span> variable</span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lower_quantile <span class="op">=</span> lower_quantile</span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, x: pd.DataFrame):</span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a><span class="co">        This function learns the lower &amp; upper quantiles of a feature</span></span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a><span class="co">        present in the dataset x.</span></span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.upper_quantile <span class="op">=</span> x[<span class="va">self</span>.variable].quantile(<span class="va">self</span>.upper_quantile)</span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lower_quantile <span class="op">=</span> x[<span class="va">self</span>.variable].quantile(<span class="va">self</span>.lower_quantile)</span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, x: pd.DataFrame):</span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a><span class="co">        This function caps the upper and lower quantiles in the dataframe</span></span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a><span class="co">        x with the values learnt in the dataframe passed in fit() method.</span></span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x.copy()</span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a>        x[<span class="va">self</span>.variable] <span class="op">=</span> np.where(</span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a>            x[<span class="va">self</span>.variable] <span class="op">&gt;</span> <span class="va">self</span>.upper_quantile,</span>
<span id="cb18-222"><a href="#cb18-222" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.upper_quantile,</span>
<span id="cb18-223"><a href="#cb18-223" aria-hidden="true" tabindex="-1"></a>            np.where(</span>
<span id="cb18-224"><a href="#cb18-224" aria-hidden="true" tabindex="-1"></a>                x[<span class="va">self</span>.variable] <span class="op">&lt;</span> <span class="va">self</span>.lower_quantile,</span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.lower_quantile,</span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a>                x[<span class="va">self</span>.variable],</span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb18-228"><a href="#cb18-228" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-229"><a href="#cb18-229" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing Scripts/utils.py</code></pre>
</div>
</div>
<ul>
<li>Initializing the <code>__init__.py</code> to make the Scripts folder a package.</li>
</ul>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:43.870539Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:43.870155Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:43.880615Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:43.879341Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:43.870504Z&quot;}" data-execution_count="12">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Scripts<span class="op">/</span><span class="fu">__init__</span>.py</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing Scripts/__init__.py</code></pre>
</div>
</div>
</section>
<section id="creating-requirements.txt-file-to-install-all-the-packages-for-our-model-training" class="level2">
<h2 class="anchored" data-anchor-id="creating-requirements.txt-file-to-install-all-the-packages-for-our-model-training">Creating requirements.txt file to install all the packages for our model training</h2>
<p>This will contain all the packages required for modeling/training the model.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:45.818485Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:45.817408Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:38:45.826283Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:38:45.824910Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:45.818428Z&quot;}" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile requirements.txt</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># pandas==2.0.0</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>torch<span class="op">==</span><span class="fl">1.13.0</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>torchvision<span class="op">==</span><span class="fl">0.14.0</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># scikit-learn==1.2.2</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>efficientnet_pytorch<span class="op">==</span><span class="fl">0.7.1</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>albumentations<span class="op">==</span><span class="fl">1.2.1</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># numpy==1.22.4</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>tqdm<span class="op">==</span><span class="fl">4.65.0</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># matplotlib==3.7.1</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>Pillow<span class="op">==</span><span class="fl">8.4.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing requirements.txt</code></pre>
</div>
</div>
</section>
<section id="installing-all-the-packages" class="level2">
<h2 class="anchored" data-anchor-id="installing-all-the-packages">Installing all the packages</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:38:47.870597Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:38:47.870003Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:39:12.651757Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:39:12.650427Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:38:47.870557Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="14">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>r requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: torch==1.13.0 in /opt/conda/lib/python3.7/site-packages (from -r requirements.txt (line 2)) (1.13.0)
Requirement already satisfied: torchvision==0.14.0 in /opt/conda/lib/python3.7/site-packages (from -r requirements.txt (line 3)) (0.14.0)
Collecting efficientnet_pytorch==0.7.1
  Downloading efficientnet_pytorch-0.7.1.tar.gz (21 kB)
  Preparing metadata (setup.py) ... done
Collecting albumentations==1.2.1
  Downloading albumentations-1.2.1-py3-none-any.whl (116 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 116.7/116.7 kB 5.3 MB/s eta 0:00:00
Collecting tqdm==4.65.0
  Downloading tqdm-4.65.0-py3-none-any.whl (77 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 77.1/77.1 kB 8.9 MB/s eta 0:00:00
Collecting Pillow==8.4.0
  Downloading Pillow-8.4.0-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (3.1 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 3.1/3.1 MB 32.8 MB/s eta 0:00:0000:0100:01
Requirement already satisfied: typing-extensions in /opt/conda/lib/python3.7/site-packages (from torch==1.13.0-&gt;-r requirements.txt (line 2)) (4.4.0)
Requirement already satisfied: requests in /opt/conda/lib/python3.7/site-packages (from torchvision==0.14.0-&gt;-r requirements.txt (line 3)) (2.28.2)
Requirement already satisfied: numpy in /opt/conda/lib/python3.7/site-packages (from torchvision==0.14.0-&gt;-r requirements.txt (line 3)) (1.21.6)
Requirement already satisfied: scipy in /opt/conda/lib/python3.7/site-packages (from albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (1.7.3)
Requirement already satisfied: scikit-image&gt;=0.16.1 in /opt/conda/lib/python3.7/site-packages (from albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (0.19.3)
Requirement already satisfied: opencv-python-headless&gt;=4.1.1 in /opt/conda/lib/python3.7/site-packages (from albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (4.5.4.60)
Requirement already satisfied: PyYAML in /opt/conda/lib/python3.7/site-packages (from albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (6.0)
Requirement already satisfied: qudida&gt;=0.0.4 in /opt/conda/lib/python3.7/site-packages (from albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (0.0.4)
Requirement already satisfied: scikit-learn&gt;=0.19.1 in /opt/conda/lib/python3.7/site-packages (from qudida&gt;=0.0.4-&gt;albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (1.0.2)
Requirement already satisfied: tifffile&gt;=2019.7.26 in /opt/conda/lib/python3.7/site-packages (from scikit-image&gt;=0.16.1-&gt;albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (2021.11.2)
Requirement already satisfied: imageio&gt;=2.4.1 in /opt/conda/lib/python3.7/site-packages (from scikit-image&gt;=0.16.1-&gt;albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (2.25.0)
Requirement already satisfied: PyWavelets&gt;=1.1.1 in /opt/conda/lib/python3.7/site-packages (from scikit-image&gt;=0.16.1-&gt;albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (1.3.0)
Requirement already satisfied: networkx&gt;=2.2 in /opt/conda/lib/python3.7/site-packages (from scikit-image&gt;=0.16.1-&gt;albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (2.6.3)
Requirement already satisfied: packaging&gt;=20.0 in /opt/conda/lib/python3.7/site-packages (from scikit-image&gt;=0.16.1-&gt;albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (23.0)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /opt/conda/lib/python3.7/site-packages (from requests-&gt;torchvision==0.14.0-&gt;-r requirements.txt (line 3)) (3.4)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /opt/conda/lib/python3.7/site-packages (from requests-&gt;torchvision==0.14.0-&gt;-r requirements.txt (line 3)) (1.26.14)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /opt/conda/lib/python3.7/site-packages (from requests-&gt;torchvision==0.14.0-&gt;-r requirements.txt (line 3)) (2.1.1)
Requirement already satisfied: certifi&gt;=2017.4.17 in /opt/conda/lib/python3.7/site-packages (from requests-&gt;torchvision==0.14.0-&gt;-r requirements.txt (line 3)) (2022.12.7)
Requirement already satisfied: threadpoolctl&gt;=2.0.0 in /opt/conda/lib/python3.7/site-packages (from scikit-learn&gt;=0.19.1-&gt;qudida&gt;=0.0.4-&gt;albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (3.1.0)
Requirement already satisfied: joblib&gt;=0.11 in /opt/conda/lib/python3.7/site-packages (from scikit-learn&gt;=0.19.1-&gt;qudida&gt;=0.0.4-&gt;albumentations==1.2.1-&gt;-r requirements.txt (line 6)) (1.2.0)
Building wheels for collected packages: efficientnet_pytorch
  Building wheel for efficientnet_pytorch (setup.py) ... done
  Created wheel for efficientnet_pytorch: filename=efficientnet_pytorch-0.7.1-py3-none-any.whl size=16446 sha256=d870e4ba77c41d05a67b458d1a03a108aaee250b6f63fca1cad356a67702a3af
  Stored in directory: /root/.cache/pip/wheels/96/3f/5f/13976445f67f3b4e77b054e65f7f4c39016e92e8358fe088db
Successfully built efficientnet_pytorch
Installing collected packages: tqdm, Pillow, efficientnet_pytorch, albumentations
  Attempting uninstall: tqdm
    Found existing installation: tqdm 4.64.1
    Uninstalling tqdm-4.64.1:
      Successfully uninstalled tqdm-4.64.1
  Attempting uninstall: Pillow
    Found existing installation: Pillow 9.4.0
    Uninstalling Pillow-9.4.0:
      Successfully uninstalled Pillow-9.4.0
  Attempting uninstall: albumentations
    Found existing installation: albumentations 1.3.0
    Uninstalling albumentations-1.3.0:
      Successfully uninstalled albumentations-1.3.0
ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
pandas-profiling 3.6.2 requires tqdm&lt;4.65,&gt;=4.48.2, but you have tqdm 4.65.0 which is incompatible.
Successfully installed Pillow-9.4.0 albumentations-1.2.1 efficientnet_pytorch-0.7.1 tqdm-4.65.0
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</code></pre>
</div>
</div>
</section>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h2>
<p>Before jumping right into the modeling and see the numbers go down or go up, it’s good to look at the data and try to make sense out of it.</p>
<p>We’ll do the same here as well, we will look at the distribution of each tabular features we have in the training and testing datasets.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:39:40.311863Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:39:40.310876Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:39:43.693455Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:39:43.692378Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:39:40.311806Z&quot;}" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.config <span class="im">import</span> Config</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">## Looking at the Data</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.read_csv(Config.train_csv_path_2020,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>                       usecols<span class="op">=</span>Config.TRAIN_COLS)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.read_csv(Config.test_csv_path_2020,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>                       usecols<span class="op">=</span>Config.TEST_COLS)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co">## Creating Image_Path for each images in 2019 &amp; 2020 training datasets</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'image_path'</span>] <span class="op">=</span> os.path.join(Config.train_folder_2020) <span class="op">+</span> train_df[<span class="st">'image_name'</span>] <span class="op">+</span> <span class="st">".jpg"</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'image_path'</span>] <span class="op">=</span> os.path.join(Config.test_folder_2020) <span class="op">+</span> test_df[<span class="st">'image_name'</span>] <span class="op">+</span> <span class="st">".jpg"</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>train_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">image_name</th>
<th data-quarto-table-cell-role="th">patient_id</th>
<th data-quarto-table-cell-role="th">sex</th>
<th data-quarto-table-cell-role="th">age_approx</th>
<th data-quarto-table-cell-role="th">anatom_site_general_challenge</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">tfrecord</th>
<th data-quarto-table-cell-role="th">image_path</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>ISIC_2637011</td>
<td>IP_7279968</td>
<td>male</td>
<td>45.0</td>
<td>head/neck</td>
<td>0</td>
<td>0</td>
<td>../input/jpeg-melanoma-512x512/train/ISIC_2637...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>ISIC_0015719</td>
<td>IP_3075186</td>
<td>female</td>
<td>45.0</td>
<td>upper extremity</td>
<td>0</td>
<td>0</td>
<td>../input/jpeg-melanoma-512x512/train/ISIC_0015...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>ISIC_0052212</td>
<td>IP_2842074</td>
<td>female</td>
<td>50.0</td>
<td>lower extremity</td>
<td>0</td>
<td>6</td>
<td>../input/jpeg-melanoma-512x512/train/ISIC_0052...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>ISIC_0068279</td>
<td>IP_6890425</td>
<td>female</td>
<td>45.0</td>
<td>head/neck</td>
<td>0</td>
<td>0</td>
<td>../input/jpeg-melanoma-512x512/train/ISIC_0068...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>ISIC_0074268</td>
<td>IP_8723313</td>
<td>female</td>
<td>55.0</td>
<td>upper extremity</td>
<td>0</td>
<td>11</td>
<td>../input/jpeg-melanoma-512x512/train/ISIC_0074...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:39:43.696012Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:39:43.695537Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:39:43.718617Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:39:43.717430Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:39:43.695965Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of Unique images id's in the training dataset are - </span><span class="sc">{</span>train_df[<span class="st">'image_name'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of Unique images id's in the training dataset are - </span><span class="sc">{</span>test_df[<span class="st">'image_name'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total number of Unique patients id's in the training dataset are - </span><span class="sc">{</span>train_df[<span class="st">'patient_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total number of Unique patients id's in the training dataset are - </span><span class="sc">{</span>test_df[<span class="st">'patient_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Number of Unique images id's in the training dataset are - 33126 

Number of Unique images id's in the training dataset are - 10982

Total number of Unique patients id's in the training dataset are - 2056

Total number of Unique patients id's in the training dataset are - 690</code></pre>
</div>
</div>
</section>
<section id="patient-id" class="level2">
<h2 class="anchored" data-anchor-id="patient-id">Patient ID</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:39:50.132165Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:39:50.131661Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:39:51.304958Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:39:51.303748Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:39:50.132122Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>patients_id_counts_train <span class="op">=</span> train_df[<span class="st">'patient_id'</span>].value_counts()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>patients_id_counts_test <span class="op">=</span> test_df[<span class="st">'patient_id'</span>].value_counts()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">2</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">19</span>,<span class="dv">10</span>), dpi<span class="op">=</span><span class="dv">80</span>, sharex<span class="op">=</span><span class="va">False</span>, sharey<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>sns.distplot(patients_id_counts_train, ax<span class="op">=</span>ax[<span class="dv">0</span>,<span class="dv">0</span>], color<span class="op">=</span><span class="st">'#3300CC'</span>, kde<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>,<span class="dv">0</span>].set_xlabel(<span class="st">"Counts"</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Patient ID counts in training data'</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>sns.distplot(patients_id_counts_test, ax<span class="op">=</span>ax[<span class="dv">0</span>,<span class="dv">1</span>], color<span class="op">=</span><span class="st">'#FF0099'</span>, kde<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>,<span class="dv">1</span>].set_xlabel(<span class="st">"Counts"</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Patient ID counts in testing data'</span>)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>sns.boxplot(patients_id_counts_train, ax<span class="op">=</span>ax[<span class="dv">1</span>,<span class="dv">0</span>], color<span class="op">=</span><span class="st">'#3300CC'</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'Counts'</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'BoxPlot of Patient ID Counts in Train data'</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>sns.boxplot(patients_id_counts_test, ax<span class="op">=</span>ax[<span class="dv">1</span>,<span class="dv">1</span>], color<span class="op">=</span><span class="st">'#FF0099'</span>)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'Counts'</span>)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'BoxPlot of Patient ID Counts in Test data'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="melanoma-final-model-kaggle_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="gender" class="level2">
<h2 class="anchored" data-anchor-id="gender">Gender</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:39:56.460603Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:39:56.459983Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:39:56.830668Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:39:56.829637Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:39:56.460562Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="18">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, sharex<span class="op">=</span><span class="va">False</span>, sharey<span class="op">=</span><span class="va">False</span>, figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">5</span>))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>sns.countplot(x<span class="op">=</span>train_df[<span class="st">'sex'</span>], color<span class="op">=</span><span class="st">'#3300CC'</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">""</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xlabel(<span class="st">'Gender Count'</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Gender Count in Training data"</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>sns.countplot(x<span class="op">=</span>test_df[<span class="st">'sex'</span>], color<span class="op">=</span><span class="st">"#FF0099"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">""</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">'Gender Count'</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Gender Count in Testing data"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="melanoma-final-model-kaggle_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="age" class="level2">
<h2 class="anchored" data-anchor-id="age">Age</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:40:01.200851Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:40:01.200187Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:40:01.510865Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:40:01.509748Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:40:01.200809Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="19">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, sharex<span class="op">=</span><span class="va">False</span> , sharey<span class="op">=</span><span class="va">False</span>, figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">5</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>sns.countplot(train_df[<span class="st">'age_approx'</span>], color<span class="op">=</span><span class="st">'#3300CC'</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Distribution of Age feature in Training Data"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xlabel(<span class="st">"Age"</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>sns.countplot(test_df[<span class="st">'age_approx'</span>], color<span class="op">=</span><span class="st">'#FF0099'</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Distribution of Age feature in Testing Data"</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">"Age"</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">'Frequency'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="melanoma-final-model-kaggle_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:40:05.000998Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:40:05.000439Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:40:05.040738Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:40:05.039623Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:40:05.000947Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="20">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>age_dist_train_test <span class="op">=</span> pd.concat(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    [train_df[<span class="st">'age_approx'</span>].describe(percentiles<span class="op">=</span>[<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.15</span>, <span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span> ,<span class="fl">0.90</span>, <span class="fl">0.91</span>, <span class="fl">0.92</span>,<span class="fl">0.93</span>, </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                                                        <span class="fl">0.94</span>, <span class="fl">0.95</span>, <span class="fl">0.96</span>, <span class="fl">0.97</span>, <span class="fl">0.98</span>, <span class="fl">0.99</span>]),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    test_df[<span class="st">'age_approx'</span>].describe(percentiles<span class="op">=</span>[<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.15</span>, <span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span> ,<span class="fl">0.90</span>, <span class="fl">0.91</span>, <span class="fl">0.92</span>,<span class="fl">0.93</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                                                        <span class="fl">0.94</span>, <span class="fl">0.95</span>, <span class="fl">0.96</span>, <span class="fl">0.97</span>, <span class="fl">0.98</span>, <span class="fl">0.99</span>])</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    ], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>age_dist_train_test.columns <span class="op">=</span> [<span class="st">'Train_Age'</span>, <span class="st">'Test_Age'</span>]</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>age_dist_train_test.T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">1%</th>
<th data-quarto-table-cell-role="th">5%</th>
<th data-quarto-table-cell-role="th">10%</th>
<th data-quarto-table-cell-role="th">15%</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">91%</th>
<th data-quarto-table-cell-role="th">92%</th>
<th data-quarto-table-cell-role="th">93%</th>
<th data-quarto-table-cell-role="th">94%</th>
<th data-quarto-table-cell-role="th">95%</th>
<th data-quarto-table-cell-role="th">96%</th>
<th data-quarto-table-cell-role="th">97%</th>
<th data-quarto-table-cell-role="th">98%</th>
<th data-quarto-table-cell-role="th">99%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Train_Age</td>
<td>33058.0</td>
<td>48.870016</td>
<td>14.380360</td>
<td>0.0</td>
<td>20.0</td>
<td>25.0</td>
<td>30.0</td>
<td>35.0</td>
<td>40.0</td>
<td>50.0</td>
<td>...</td>
<td>70.0</td>
<td>70.0</td>
<td>70.0</td>
<td>70.0</td>
<td>70.0</td>
<td>75.0</td>
<td>75.0</td>
<td>75.0</td>
<td>80.0</td>
<td>90.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Test_Age</td>
<td>10982.0</td>
<td>49.525587</td>
<td>14.370589</td>
<td>10.0</td>
<td>20.0</td>
<td>30.0</td>
<td>30.0</td>
<td>35.0</td>
<td>40.0</td>
<td>50.0</td>
<td>...</td>
<td>70.0</td>
<td>70.0</td>
<td>70.0</td>
<td>70.0</td>
<td>75.0</td>
<td>75.0</td>
<td>80.0</td>
<td>80.0</td>
<td>85.0</td>
<td>90.0</td>
</tr>
</tbody>
</table>

<p>2 rows × 22 columns</p>
</div>
</div>
</div>
</section>
<section id="anatom_site_general_challenge" class="level2">
<h2 class="anchored" data-anchor-id="anatom_site_general_challenge">anatom_site_general_challenge</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:40:26.321998Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:40:26.321406Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:40:27.176207Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:40:27.175150Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:40:26.321941Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, sharex<span class="op">=</span><span class="va">False</span> , sharey<span class="op">=</span><span class="va">False</span>, figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">5</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>train_anatom_site_general <span class="op">=</span> train_df[<span class="st">"anatom_site_general_challenge"</span>].value_counts().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>test_anatom_site_general <span class="op">=</span> test_df.anatom_site_general_challenge.value_counts().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>train_anatom_site_general.index.values, y<span class="op">=</span>train_anatom_site_general.values, ax<span class="op">=</span>ax[<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xlabel(<span class="st">""</span>)<span class="op">;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> ax[<span class="dv">0</span>].get_xticklabels()<span class="op">;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xticklabels(labels, rotation<span class="op">=</span><span class="dv">90</span>)<span class="op">;</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Image locations in train"</span>)<span class="op">;</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>test_anatom_site_general.index.values, y<span class="op">=</span>test_anatom_site_general.values, ax<span class="op">=</span>ax[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">""</span>)<span class="op">;</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> ax[<span class="dv">1</span>].get_xticklabels()<span class="op">;</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xticklabels(labels, rotation<span class="op">=</span><span class="dv">90</span>)<span class="op">;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Image locations in test"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="melanoma-final-model-kaggle_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="target" class="level2">
<h2 class="anchored" data-anchor-id="target">Target</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:40:37.920650Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:40:37.920188Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:40:37.933282Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:40:37.931921Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:40:37.920608Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="23">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'target'</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>, dropna<span class="op">=</span><span class="va">False</span>) <span class="op">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>0    98.237034
1     1.762966
Name: target, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="sex-vs.-target-anatom_site_general_challenge-vs.-target" class="level2">
<h2 class="anchored" data-anchor-id="sex-vs.-target-anatom_site_general_challenge-vs.-target">Sex Vs. Target &amp; anatom_site_general_challenge Vs. Target</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:40:39.210935Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:40:39.210150Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:40:39.721771Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:40:39.720654Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:40:39.210893Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, sharex<span class="op">=</span><span class="va">False</span>, sharey<span class="op">=</span><span class="va">False</span>, figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">5</span>))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>sns.countplot(x<span class="op">=</span><span class="st">'target'</span>, hue<span class="op">=</span><span class="st">'sex'</span>,data<span class="op">=</span>train_df, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xlabel(<span class="st">"Target"</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">'Count'</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Sex Vs. Target"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>sns.countplot(x<span class="op">=</span><span class="st">'target'</span>, hue<span class="op">=</span><span class="st">'anatom_site_general_challenge'</span>,data<span class="op">=</span>train_df, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">"Target"</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">'Count'</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Sex Vs. anatom_site_general_challenge"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="melanoma-final-model-kaggle_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="age-vs.-target" class="level2">
<h2 class="anchored" data-anchor-id="age-vs.-target">Age Vs. Target</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:40:43.090705Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:40:43.090303Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T08:40:43.833667Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T08:40:43.832650Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:40:43.090649Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="25">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">5</span>))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>sns.distplot(train_df.loc[train_df[<span class="st">'target'</span>] <span class="op">==</span> <span class="dv">0</span>][<span class="st">'age_approx'</span>], bins<span class="op">=</span><span class="dv">50</span>, label<span class="op">=</span><span class="st">'Benign'</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>sns.distplot(train_df.loc[train_df[<span class="st">'target'</span>] <span class="op">==</span> <span class="dv">1</span>][<span class="st">'age_approx'</span>], bins<span class="op">=</span><span class="dv">50</span>, label<span class="op">=</span><span class="st">'Malignant'</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Density'</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Age Vs. Target distribution"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="melanoma-final-model-kaggle_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="training-our-model-with-no-tabular-features" class="level2">
<h2 class="anchored" data-anchor-id="training-our-model-with-no-tabular-features">Training our model with No Tabular features</h2>
<ul>
<li>For now, we will run/train the model on a single fold only.</li>
</ul>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T08:40:47.701065Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T08:40:47.700072Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T13:13:42.750919Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T13:13:42.749541Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T08:40:47.701011Z&quot;}" data-execution_count="26">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.train_model <span class="im">import</span> run_model</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>run_model(fold<span class="op">=</span><span class="dv">0</span>, train_df<span class="op">=</span>train_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1a6b3388decd4af19ce5edebbb012991","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded pretrained weights for efficientnet-b5
Validation loss decreased (inf --&gt; 0.071890).  Saving model ...
Epoch : 1 | train_loss : 0.0986 | valid_loss : 0.0719 | valid_auc : 0.8579 
Validation loss decreased (0.071890 --&gt; 0.067238).  Saving model ...
Epoch : 2 | train_loss : 0.0749 | valid_loss : 0.0672 | valid_auc : 0.8902 
EarlyStopping counter: 1 out of 2
Epoch : 3 | train_loss : 0.0708 | valid_loss : 0.0709 | valid_auc : 0.8746 
Validation loss decreased (0.067238 --&gt; 0.065598).  Saving model ...
Epoch : 4 | train_loss : 0.0706 | valid_loss : 0.0656 | valid_auc : 0.8971 
EarlyStopping counter: 1 out of 2
Epoch : 5 | train_loss : 0.0683 | valid_loss : 0.0673 | valid_auc : 0.9015 
Total training time: 16369.841 seconds</code></pre>
</div>
</div>
</section>
<section id="generating-submission-file-on-the-test-dataset" class="level2">
<h2 class="anchored" data-anchor-id="generating-submission-file-on-the-test-dataset">Generating submission file on the test dataset</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T13:15:47.344072Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T13:15:47.343018Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T13:19:42.046766Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T13:19:42.045573Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T13:15:47.344010Z&quot;}" data-execution_count="27">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.predict_on_test <span class="im">import</span> predict_on_test_and_generate_submission_file</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>model_path <span class="op">=</span> <span class="st">"../working/Models/efficientnet_b5_checkpoint_fold_0.pt"</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>predict_on_test_and_generate_submission_file(test_df<span class="op">=</span>test_df,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                                            use_tabular_features<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                                            model_path<span class="op">=</span>model_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded pretrained weights for efficientnet-b5</code></pre>
</div>
</div>
</section>
<section id="building-gradio-demo" class="level2">
<h2 class="anchored" data-anchor-id="building-gradio-demo">Building Gradio demo</h2>
<p>Now that we have finalized the model we’ll be deploying, we will use this EfficientNet-B5 model to predict on new images.</p>
<p>For this project I will be using <a href="https://gradio.app/">Gradio</a> library (product of HuggingFace).</p>
<p>Why Gradio? The homepage of Gradio descibes it as: &gt; Gradio is the fastest way to build/demo your machine learning model with a friendly web interface so that anyone can use it, anywhere.</p>
<section id="gradio-overview" class="level3">
<h3 class="anchored" data-anchor-id="gradio-overview">Gradio Overview</h3>
<p>In general, we can have any combination of inputs like - Images - Tabular data - Text - Numbers - Video - Audio - etc.</p>
<p>In our case we have images and inputs and the output is returned as a probability of whether a patient is sufferig from melanoma skin cancer disease.</p>
<p>Gradio provides an interface that maps from the input(s) to output(s).</p>
<pre><code>gr.Interface(function, inputs, outputs)</code></pre>
<p>Where, <code>fn</code> is a python function to map inputs to outputs</p>
<p>Gradio provides a very helpful <code>Interface</code> class to create an <code>inputs -&gt; model/function -&gt; outputs</code> workflow where the inputs and outputs could be almost anything we want.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T13:21:29.483743Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T13:21:29.482627Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T13:21:45.410448Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T13:21:45.408502Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T13:21:29.483689Z&quot;}" data-execution_count="28">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Installing Gradio and importing it. </span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>q gradio</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Gradio version : </span><span class="sc">{</span>gr<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv
Gradio version : 3.27.0</code></pre>
</div>
</div>
</section>
</section>
<section id="creating-a-model-instance-and-putting-it-on-the-cpu" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-model-instance-and-putting-it-on-the-cpu">Creating a model instance and putting it on the CPU</h2>
<p>First, let’s make sure our EfficientNetB5 model on CPU</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T13:21:45.414435Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T13:21:45.413043Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T13:21:45.957341Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T13:21:45.956204Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T13:21:45.414387Z&quot;}" data-execution_count="29">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> albumentations <span class="im">as</span> A</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Scripts.model <span class="im">import</span> Model</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>efficientnet_b5_model <span class="op">=</span> Model()</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>efficientnet_b5_model <span class="op">=</span> torch.nn.DataParallel(efficientnet_b5_model) <span class="co">## Must wrap our model in nn.DataParallel()</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">## if used multi-gpu's to train the model otherwise we would get state_dict keys mismatch error.</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>efficientnet_b5_model.load_state_dict(</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    torch.load(</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        f<span class="op">=</span><span class="st">'efficientnet_b5_checkpoint_fold_0.pt'</span>,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        map_location<span class="op">=</span>torch.device(<span class="st">"cpu"</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(<span class="bu">iter</span>(model.parameters())).device</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded pretrained weights for efficientnet-b5</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>device(type='cpu')</code></pre>
</div>
</div>
</section>
<section id="creating-a-function-to-predict-on-a-single-images" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-function-to-predict-on-a-single-images">Creating a function to predict on a single images</h2>
<p>We create a function that takes an input: image -&gt; transform -&gt; predict with EfficientNetB5 -&gt; output: probability.</p>
<p>This will be our <code>fn</code> parameter for our Gradio Interface.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T13:21:47.483431Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T13:21:47.482287Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T13:21:47.492354Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T13:21:47.491213Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T13:21:47.483382Z&quot;}" data-execution_count="30">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">## predict on a single image</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_on_single_image(img):</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Function takes an image, transforms for </span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">    model training like normalizing the statistics</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">    of the image. Converting the numpy array into</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">    torch tensor and passing through the model</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">    to get the prediction probability of a patient</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co">    having melanoma. </span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> np.array(img)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    transforms <span class="op">=</span> A.Compose([A.Resize(<span class="dv">512</span>,<span class="dv">512</span>),</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>        A.Normalize(mean<span class="op">=</span>(<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>), </span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>                    std<span class="op">=</span>(<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>), </span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>                    max_pixel_value<span class="op">=</span><span class="fl">255.0</span>, </span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>                    always_apply<span class="op">=</span><span class="va">True</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        )]</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> transforms(image<span class="op">=</span>img)[<span class="st">'image'</span>]</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> np.transpose(img, (<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)).astype(np.float32)</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> torch.tensor(image, dtype<span class="op">=</span>torch.<span class="bu">float</span>).unsqueeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.inference_mode():</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> torch.sigmoid(model(image))</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>        prob_of_melanoma <span class="op">=</span> probs[<span class="dv">0</span>].item()</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>        prob_of_not_having_melanoma <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> prob_of_melanoma</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>        pred_label <span class="op">=</span> {<span class="st">"Probability of Having Melanoma"</span>: prob_of_melanoma, </span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Probability of Not having Melanoma"</span>: prob_of_not_having_melanoma} </span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pred_label</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s see our function by performing a prediction of an image from the training dataset.</p>
<p>We’ll get some images from training dataset and extract the images paths list. Then we’ll open an image with <code>Image.open()</code>.</p>
<p>Finally, we pass the image to <code>predict_on_single_image()</code>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T13:27:53.462518Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T13:27:53.462123Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T13:27:54.406182Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T13:27:54.404843Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T13:27:53.462482Z&quot;}" data-execution_count="44">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co">## Taking some images out</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>images <span class="op">=</span> train_df.iloc[<span class="dv">1</span>:<span class="dv">10</span>,]</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>images_paths_list <span class="op">=</span> images[<span class="st">'image_path'</span>].tolist()</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co">## Opening an Image</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> Image.<span class="bu">open</span>(images_paths_list[<span class="dv">8</span>])</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="co">## Predicting on the image using the function</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>predict_on_single_image(img)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>{'Probability of Having Melanoma': 0.5395416617393494,
 'Probability of Not having Melanoma': 0.46045833826065063}</code></pre>
</div>
</div>
<section id="creating-a-list-of-example-images" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-list-of-example-images">Creating a list of example images</h3>
<p>Before we create a demo, we first create a list of examples.</p>
<p>Gradio’s <code>Interface</code> class takes a list of <code>examples</code> parameter is a list of lists.</p>
<p>So, we create a list of lists containing the filepaths of images.</p>
<p>Our gradio demo will showcase these as example inputs to our demo so people can try.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T13:22:03.293364Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T13:22:03.292633Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T13:22:03.302047Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T13:22:03.300416Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T13:22:03.293325Z&quot;}" data-execution_count="32">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>example_list <span class="op">=</span> [[<span class="bu">str</span>(file_path)] <span class="cf">for</span> file_path <span class="kw">in</span> images_paths_list]</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>example_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>[['../input/jpeg-melanoma-512x512/train/ISIC_0015719.jpg'],
 ['../input/jpeg-melanoma-512x512/train/ISIC_0052212.jpg'],
 ['../input/jpeg-melanoma-512x512/train/ISIC_0068279.jpg']]</code></pre>
</div>
</div>
</section>
<section id="building-a-gradio-interface" class="level3">
<h3 class="anchored" data-anchor-id="building-a-gradio-interface">Building a Gradio interface</h3>
<p>Putting everything together -&gt;</p>
<p>Gradio Interface Workflow: input: image -&gt; transform -&gt; predict with EfficientNetB5 model -&gt; probability: output</p>
<p>We can do with the <code>Gr.Interface()</code> class with the following parameters: - fn: a python function that maps from inputs to outputs, in our case <code>the predict_on_single_image()</code> function. - inputs: the input to our Interface, such as image using <a href="https://gradio.app/docs/#image">gradio.Image()</a>. - outputs: the output of the Interface once the inputs are processed with the <code>fn</code>, such as a Number <a href="https://gradio.app/docs/#number">gradio.Number()</a> (for our case probability). - examples: a list of examples to showcase for the demo. - title: a string title of the demo. - description: a string description of the demo.</p>
<p>Once, we’ve created a demo instance of <code>gr.Interface()</code>, we use <code>demo.launch()</code> command.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-04-19T13:22:15.468088Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-04-19T13:22:15.467449Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-04-19T13:22:21.443302Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-04-19T13:22:21.442176Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-04-19T13:22:15.468046Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="33">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co">## Creating the title and description strings  </span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>title <span class="op">=</span> <span class="st">"Melanoma Cancer Detection App"</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>description <span class="op">=</span> <span class="st">'An efficientnet-b5 model that predicts the probability of a patient having melanoma skin cancer or not.'</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co">## Create the Gradio demo</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>demo <span class="op">=</span> gr.Interface(fn<span class="op">=</span>predict_on_single_image,</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>                   inputs<span class="op">=</span>gr.Image(<span class="bu">type</span><span class="op">=</span><span class="st">'pil'</span>),</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>                   outputs<span class="op">=</span>[gr.Label(label<span class="op">=</span><span class="st">'Probabilities'</span>)],</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>                   examples<span class="op">=</span>example_list, title<span class="op">=</span>title,</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>                   description<span class="op">=</span>description)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="co">## Launch the demo!</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>demo.launch(debug<span class="op">=</span><span class="va">False</span>, share<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running on local URL:  http://127.0.0.1:7860
Running on public URL: https://e228186381e2781228.gradio.live

This share link expires in 72 hours. For free permanent hosting and GPU upgrades (NEW!), check out Spaces: https://huggingface.co/spaces</code></pre>
</div>
<div class="cell-output cell-output-display">
<div><iframe src="https://e228186381e2781228.gradio.live" width="100%" height="500" allow="autoplay; camera; microphone; clipboard-read; clipboard-write;" frameborder="0" allowfullscreen=""></iframe></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code></code></pre>
</div>
</div>
<p>Woow!!!</p>
<p>Our application is up and running, this link is only temporary and and it remains ony for 72 hours. For permanent hosting, we can upload our Gradio app Interface to <a href="https://huggingface.co/spaces">HuggingFace Spaces</a>.</p>
<p>Now download all the files and folders from kaggle output manually &amp; this kaggle kernel locally</p>
</section>
</section>
<section id="turning-our-melanoma-skin-cancer-detection-gradio-demo-into-a-deployable-app" class="level2">
<h2 class="anchored" data-anchor-id="turning-our-melanoma-skin-cancer-detection-gradio-demo-into-a-deployable-app">Turning our Melanoma skin cancer detection Gradio Demo into a deployable app</h2>
<p>We’ll deploy the demo application on HuggingFace Spaces.</p>
<p>What is HuggingFace Spaces?</p>
<p>It is a resource that allows anybody to host and share machine learning application.</p>
<section id="deployed-gradio-app-structure" class="level3">
<h3 class="anchored" data-anchor-id="deployed-gradio-app-structure">Deployed Gradio App Structure</h3>
<p>To upload our gradio app, we’ll want to put everything together into a singe directory.</p>
<p>For example, our demo might live at the path <code>demos/melanoma_skin_cancer_files</code> with the following structure:</p>
<pre><code>demos/
    └── melanoma_skin_cancer_files/
        ├── efficientnet_b5_checkpoint_fold_0.pt
        ├── app.py
        ├── examples/
        │   ├── image_1.jpg
        │   ├── image_2.jpg
        │   └── image_3.jpg
        ├── model.py
        └── requirements.txt</code></pre>
<p>Where: - <code>efficientnet_b5_checkpoint_fold_0</code> is our trained model. - <code>app.py</code> contains our Gradio app. <strong>Note</strong>: <code>app.py</code> is the default filename used for HuggingFace Spaces, if we deploy our apps there. - <code>examples</code> contains sample images to showcase the demo of our Gradio application. - <code>model.py</code> contains the main model/transformations code associated with our model. - <code>requirements.txt</code> file contains the dependencies/packages to run our application such as torch, albumentations, torchvision, gradio, numpy.</p>
</section>
<section id="creating-a-demo-folder-to-store-our-melanoma-skin-cancer-app-files" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-demo-folder-to-store-our-melanoma-skin-cancer-app-files">Creating a demo folder to store our Melanoma skin cancer App files</h3>
<p>To begin, we’ll create an empty directory <code>demos/</code> that will contain all our necessary files for the application.</p>
<p>We can achive this using Python’s <code>pathlib.Path("path_of_dir")</code> to establish directory path and then <code>pathlib.Path("path_of_dir").mkdir()</code> to create it.</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">############### ROOT_DIR : I Have put the files in my E: drive</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Importing Packages </span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>ROOT_DIR <span class="op">=</span> <span class="st">"</span><span class="ch">\\</span><span class="st">"</span>.join(os.getcwd().split(<span class="st">"</span><span class="ch">\\</span><span class="st">"</span>)[:<span class="dv">2</span>])</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co">## Create Melanoma skin cancer demo path</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>melanoma_app_demo_path <span class="op">=</span> Path(<span class="ss">f"</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/demos/melanoma_skin_cancer_files"</span>)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co">## Removing files that might already exist and creating a new directory.</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> melanoma_app_demo_path.exists():</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(melanoma_app_demo_path)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    melanoma_app_demo_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, <span class="co"># Do we want to make parent folders?</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>                                exist_ok<span class="op">=</span><span class="va">True</span>) <span class="co"># Create even if they already exists? </span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">## If the path doesn't exist, create one </span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    melanoma_app_demo_path.mkdir(parents<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>                                exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="creating-a-folder-of-example-images-to-use-with-our-melanoma-skin-cancer-demo" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-folder-of-example-images-to-use-with-our-melanoma-skin-cancer-demo">Creating a folder of example images to use with our Melanoma skin cancer demo</h3>
<p>Now we’ll create an empty directory called <code>examples</code> and store some images (namely - ISIC_0015719.jpg, ISIC_0052212.jpg, ISIC_0068279.jpg) from the training dataset provided in the competition (which we download manually) from the <a href="https://www.kaggle.com/datasets/cdeotte/jpeg-melanoma-512x512">here</a>. Download the 1ts three images from the training dataset mentioned above.</p>
<p>Put these images in the Data/Input (whatever you want to call) folder.</p>
<p>To do so we’ll:</p>
<ol type="1">
<li>Create an empty directory <code>examples/</code> within the <code>demos/melanoma_skin_cancer_files</code> directory.</li>
<li>Download the top 3 mentioned images from the training dataset from the link above.</li>
<li>Collect the filepaths into a list.</li>
<li>Copy these 3 images from the train dataset to the <code>demos/melanom_skin_cancer_files/examples/</code> directory.</li>
</ol>
<div class="cell" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co">## Create examples directory</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>melanoma_app_examples_path <span class="op">=</span> melanoma_app_demo_path <span class="op">/</span> <span class="st">"examples"</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>melanoma_app_examples_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="co">## collecting the image paths of 4 images </span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>melanoma_app_examples <span class="op">=</span> [Path(<span class="ss">f"</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/train/ISIC_0015719.jpg"</span>),</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>                        Path(<span class="ss">f'</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/train/ISIC_0052212.jpg'</span>),</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>                        Path(<span class="ss">f'</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/train/ISIC_0068279.jpg'</span>),</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>                        Path(<span class="ss">f'</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/train/ISIC_0149568.jpg'</span>)]</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> example <span class="kw">in</span> melanoma_app_examples:</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    destination <span class="op">=</span> melanoma_app_examples_path <span class="op">/</span> example.name</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    shutil.copy(src<span class="op">=</span>example, dst<span class="op">=</span>destination)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">## collecting the image paths of some more images but this time from the testing folder </span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>melanoma_app_examples <span class="op">=</span> [Path(<span class="ss">f"</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/test/ISIC_0052060.jpg"</span>),</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                        Path(<span class="ss">f'</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/test/ISIC_0082004.jpg'</span>),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                        Path(<span class="ss">f'</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/test/ISIC_0082785.jpg'</span>),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                        Path(<span class="ss">f'</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/test/ISIC_0105104.jpg'</span>),</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                        Path(<span class="ss">f'</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/test/ISIC_0112420.jpg'</span>),</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>                        Path(<span class="ss">f'</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/test/ISIC_0155983.jpg'</span>),</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                        Path(<span class="ss">f'</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ss">/input/jpeg-melanoma-512x512/test/ISIC_0171865.jpg'</span>)]</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> example <span class="kw">in</span> melanoma_app_examples:</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    destination <span class="op">=</span> melanoma_app_examples_path <span class="op">/</span> example.name</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    shutil.copy(src<span class="op">=</span>example, dst<span class="op">=</span>destination)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we verify our example images are present, let’s list the contents of our <code>demo/melanoma_skin_cancer/examples/</code> directory with <code>os.listdir()</code> and then format the filepaths into a list of lists (to make it compatible with the Gradio’s <code>gradio.Interface()</code>, example parameter).</p>
<div class="cell" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>example_list <span class="op">=</span> [[<span class="st">"examples/"</span> <span class="op">+</span> example] <span class="cf">for</span> example <span class="kw">in</span> os.listdir(melanoma_app_examples_path)]</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>example_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>[['examples/ISIC_0015719.jpg'],
 ['examples/ISIC_0052060.jpg'],
 ['examples/ISIC_0052212.jpg'],
 ['examples/ISIC_0068279.jpg'],
 ['examples/ISIC_0082004.jpg'],
 ['examples/ISIC_0082785.jpg'],
 ['examples/ISIC_0105104.jpg'],
 ['examples/ISIC_0112420.jpg'],
 ['examples/ISIC_0149568.jpg'],
 ['examples/ISIC_0155983.jpg'],
 ['examples/ISIC_0171865.jpg']]</code></pre>
</div>
</div>
</section>
<section id="moving-our-trained-efficientnet-b5-model-into-our-melanoma-demo-directory." class="level3">
<h3 class="anchored" data-anchor-id="moving-our-trained-efficientnet-b5-model-into-our-melanoma-demo-directory.">Moving our trained EfficientNet-B5 model into our Melanoma demo directory.</h3>
<p>We previously saved our model binary file into the <code>Models</code> directory while training as <code>Models/efficientnet_b5_checkpoint_fold_0.pt</code>.</p>
<p>We use Python’s <code>shutil.move()</code> method and passing in <code>src</code>(the source path of the target file) and <code>dst</code> (the destination folder path of the target file to be moved into) parameters.</p>
<div class="cell" data-execution_count="4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Importing Libraries</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co">## Create a source path for our target model</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>efficientnet_b5_model_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>ROOT_DIR<span class="sc">}</span><span class="ch">\\</span><span class="ss">output</span><span class="ch">\\</span><span class="ss">working</span><span class="ch">\\</span><span class="ss">Models</span><span class="ch">\\</span><span class="ss">efficientnet_b5_checkpoint_fold_0.pt"</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co">## Create a destination path for our target model</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>efficientnet_b5_model_destination <span class="op">=</span> melanoma_app_demo_path <span class="op">/</span> efficientnet_b5_model_path.split(<span class="st">"</span><span class="ch">\\</span><span class="st">"</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="co">## Try to move the file</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Attempting to move the </span><span class="sc">{</span>efficientnet_b5_model_path<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>efficientnet_b5_model_destination<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Move the model</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    shutil.move(src<span class="op">=</span>efficientnet_b5_model_path,</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>               dst<span class="op">=</span>efficientnet_b5_model_destination)</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Model move completed"</span>)</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="co">## If the model has already been moved, check if it exists</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"No model found at </span><span class="sc">{</span>efficientnet_b5_model_path<span class="sc">}</span><span class="ss">, perhaps it's already moved."</span>)</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Model already exists at </span><span class="sc">{</span>efficientnet_b5_model_destination<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>efficientnet_b5_model_destination<span class="sc">.</span>exists()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Attempting to move the E:\Melanoma_skin_cancer_detection\output\working\Models\efficientnet_b5_checkpoint_fold_0.pt to E:\Melanoma_skin_cancer_detection\demos\melanoma_skin_cancer_files\efficientnet_b5_checkpoint_fold_0.pt
Model move completed</code></pre>
</div>
</div>
</section>
<section id="turning-our-efficientnet-b5-model-into-a-python-script-model.py" class="level3">
<h3 class="anchored" data-anchor-id="turning-our-efficientnet-b5-model-into-a-python-script-model.py">Turning our EfficientNet-B5 model into a Python script (<code>model.py</code>)</h3>
<p>Our current model’s <code>state_dict()</code> is saved to <code>demos/melanoma_skin_cancer/efficientnet_b5_checkpoint_fold_0.pt</code>.</p>
<p>To load it it we can use <code>model.load_state_dict()</code> with <code>torch.load()</code>. But before that we need to instantiate a model.</p>
<p>To do this in a modular fashion we’ll create a script model.py which contains the model definition into a function called <code>Model()</code>.</p>
<div class="cell" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Now if we look into which directory we are currently, we'll find that using the following code</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>os.getcwd()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>'E:\\Melanoma_skin_cancer_detection\\notebooks'</code></pre>
</div>
</div>
<p>Now we will move into the demos directory where we will write some helper utilities.</p>
<p>In <code>cd ../demos/</code>: <code>..</code> means we are moving outside of the notebooks directory. <code>demos/</code>: means we moving inside the demos directory.</p>
<div class="cell" data-execution_count="6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>cd ..<span class="op">/</span>demos<span class="op">/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>E:\Melanoma_skin_cancer_detection\demos</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile melanoma_skin_cancer_files<span class="op">/</span>model.py</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> efficientnet_pytorch <span class="im">import</span> EfficientNet</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates an efficientnet-b5 model instance.    </span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_name<span class="op">=</span><span class="st">"efficientnet-b5"</span>, pool_type<span class="op">=</span>F.adaptive_avg_pool2d):</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pool_type <span class="op">=</span> pool_type</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_name <span class="op">=</span> model_name</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.backbone <span class="op">=</span> EfficientNet.from_pretrained(model_name)</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>        in_features <span class="op">=</span> <span class="bu">getattr</span>(<span class="va">self</span>.backbone, <span class="st">"_fc"</span>).in_features</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.classifier <span class="op">=</span> nn.Linear(in_features, <span class="dv">1</span>)</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> <span class="va">self</span>.pool_type(<span class="va">self</span>.backbone.extract_features(x), <span class="dv">1</span>)</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> features.view(x.size(<span class="dv">0</span>), <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.classifier(features)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing melanoma_skin_cancer_files/model.py</code></pre>
</div>
</div>
</section>
<section id="turning-our-melanoma-skin-cancer-gradio-app-into-a-python-script-app.py" class="level3">
<h3 class="anchored" data-anchor-id="turning-our-melanoma-skin-cancer-gradio-app-into-a-python-script-app.py">Turning our Melanoma Skin Cancer Gradio App into a Python Script (<code>app.py</code>)</h3>
<div class="cell" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile melanoma_skin_cancer_files<span class="op">/</span>app.py</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Importing Libraries</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> model <span class="im">import</span> Model</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> albumentations <span class="im">as</span> A</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co">## Creating a model instance</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>efficientnet_b5_model <span class="op">=</span>  Model()</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>efficientnet_b5_model <span class="op">=</span> torch.nn.DataParallel(efficientnet_b5_model) <span class="co">## Must wrap our model in nn.DataParallel()</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">## if used multi-gpu's to train the model otherwise we would get state_dict keys mismatch error.</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>efficientnet_b5_model.load_state_dict(</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    torch.load(</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>        f<span class="op">=</span><span class="st">'efficientnet_b5_checkpoint_fold_0.pt'</span>,</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>        map_location<span class="op">=</span>torch.device(<span class="st">"cpu"</span>)</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="co">## Predict on a single image</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_on_single_image(img):</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Function takes an image, transforms for </span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="co">    model training like normalizing the statistics</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a><span class="co">    of the image. Converting the numpy array into</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a><span class="co">    torch tensor and passing through the model</span></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="co">    to get the prediction probability of a patient</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a><span class="co">    having melanoma. </span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> np.array(img)</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>    transforms <span class="op">=</span> A.Compose([A.Resize(<span class="dv">512</span>,<span class="dv">512</span>),</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>        A.Normalize(mean<span class="op">=</span>(<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>), </span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>                    std<span class="op">=</span>(<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>), </span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>                    max_pixel_value<span class="op">=</span><span class="fl">255.0</span>, </span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>                    always_apply<span class="op">=</span><span class="va">True</span></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>        )]</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> transforms(image<span class="op">=</span>img)[<span class="st">'image'</span>]</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> np.transpose(img, (<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)).astype(np.float32)</span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> torch.tensor(image, dtype<span class="op">=</span>torch.<span class="bu">float</span>).unsqueeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>    efficientnet_b5_model.<span class="bu">eval</span>()</span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.inference_mode():</span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> torch.sigmoid(efficientnet_b5_model(image))</span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>        prob_of_melanoma <span class="op">=</span> probs[<span class="dv">0</span>].item()</span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>        prob_of_not_having_melanoma <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> prob_of_melanoma</span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>        pred_label <span class="op">=</span> {<span class="st">"Probability of Having Melanoma"</span>: prob_of_melanoma, </span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Probability of Not having Melanoma"</span>: prob_of_not_having_melanoma} </span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pred_label</span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a><span class="co">## Gradio App</span></span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a><span class="co">## Examples directory path</span></span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>melanoma_app_examples_path <span class="op">=</span> <span class="st">"examples"</span></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a><span class="co">## Creating the title and description strings  </span></span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>title <span class="op">=</span> <span class="st">"Melanoma Cancer Detection App"</span></span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>description <span class="op">=</span> <span class="st">'An efficientnet-b5 model that predicts the probability of a patient having melanoma skin cancer or not.'</span></span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>example_list <span class="op">=</span> [[<span class="st">"examples/"</span> <span class="op">+</span> example] <span class="cf">for</span> example <span class="kw">in</span> os.listdir(melanoma_app_examples_path)]</span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a><span class="co">## Create the Gradio demo</span></span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>demo <span class="op">=</span> gr.Interface(fn<span class="op">=</span>predict_on_single_image,</span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>                   inputs<span class="op">=</span>gr.Image(<span class="bu">type</span><span class="op">=</span><span class="st">'pil'</span>),</span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>                   outputs<span class="op">=</span>[gr.Label(label<span class="op">=</span><span class="st">'Probabilities'</span>)],</span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>                   examples<span class="op">=</span>example_list, title<span class="op">=</span>title,</span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a>                   description<span class="op">=</span>description)</span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a><span class="co">## Launch the demo!</span></span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a>demo.launch(debug<span class="op">=</span><span class="va">False</span>, share<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing melanoma_skin_cancer_files/app.py</code></pre>
</div>
</div>
</section>
<section id="creating-a-requirements.txt-file-for-our-gradio-apprequirements.txt" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-requirements.txt-file-for-our-gradio-apprequirements.txt">Creating a requirements.txt file for our Gradio App(<code>requirements.txt</code>)</h3>
<p>This is the last file we need to create for our application.</p>
<p>This file contains all the necessary packages for our Gradio application.</p>
<p>When we deploy our demo app to HuggingFace Spaces, it will search through this file and install the dependencies we mention so our appication can run.</p>
<ol type="1">
<li><code>torch==1.13.0</code></li>
<li><code>torchvision==0.14.0</code></li>
<li><code>albumentations==1.2.1</code></li>
<li><code>efficientnet_pytorch==0.7.1</code></li>
<li><code>Pillow==8.4.0</code></li>
<li><code>numpy==1.22.4</code></li>
<li><code>gradio==3.1.4</code></li>
</ol>
<div class="cell" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile melanoma_skin_cancer_files<span class="op">/</span>requirements.txt</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>torch<span class="op">==</span><span class="fl">1.13.0</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>torchvision<span class="op">==</span><span class="fl">0.14.0</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>albumentations<span class="op">==</span><span class="fl">1.2.1</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>efficientnet_pytorch<span class="op">==</span><span class="fl">0.7.1</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>Pillow<span class="op">==</span><span class="fl">8.4.0</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>numpy<span class="op">==</span><span class="fl">1.22.4</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>gradio<span class="op">==</span><span class="fl">3.1.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Writing melanoma_skin_cancer_files/requirements.txt</code></pre>
</div>
</div>
</section>
</section>
<section id="deploying-our-application-to-huggingface-spaces" class="level2">
<h2 class="anchored" data-anchor-id="deploying-our-application-to-huggingface-spaces">Deploying our Application to HuggingFace Spaces</h2>
<p>To deploy our demo, there are 2 main options for uploading to HuggingFace Spaces</p>
<ol type="1">
<li><a href="https://huggingface.co/docs/hub/repositories-getting-started#adding-files-to-a-repository-web-ui">Uploading via the Hugging Face Web Interface (easiest)</a></li>
<li><a href="https://huggingface.co/docs/hub/repositories-getting-started#terminal">Uploading via the command line or terminal</a></li>
</ol>
<p>NOTE: To host any application on HuggingFace, we first need to <a href="https://huggingface.co/join">sign up for a free HuggingFace Account</a></p>
<section id="running-our-application-locally" class="level3">
<h3 class="anchored" data-anchor-id="running-our-application-locally">Running our Application locally</h3>
<ol type="1">
<li>Open the terminal or command prompt.</li>
<li>Changing the <code>melanoma_skin_cancer_files</code> directory (cd melanoma_skin_cancer_files).</li>
<li>Creating an environment <code>(python3 -m venv env)</code> or use <code>(python -m venv env)</code>.</li>
<li>Activating the environment <code>(source env/Scripts/activate)</code>.</li>
<li>Installing the <code>requirements.txt</code> using <code>pip install -r requirements.txt</code>. &gt; If faced any errors, we might need to upgrade <code>pip</code> using <code>pip install --upgrade pip</code>.<br>
</li>
<li>Run the app <code>(python3 app.py).</code></li>
</ol>
<p>This should results in a Gradio demo locally at the URL such as : <code>http://127.0.0.1:7860/</code>.</p>
</section>
<section id="uploading-to-hugging-face" class="level3">
<h3 class="anchored" data-anchor-id="uploading-to-hugging-face">Uploading to Hugging Face</h3>
<p>We’ve verified our Melanoma_skin_cancer detection application is working in our local system.</p>
<p>To upload our application to Hugging Face Spaces, we need to do the following.</p>
<ol type="1">
<li><a href="https://huggingface.co/welcome">Sign up</a> for a Hugging Face account.</li>
<li>Start a new Hugging Face Space by going to our profile at the top right corner and then select <a href="https://huggingface.co/new-space">New Space</a>.</li>
<li>Declare the name to the space like <code>Chirag1994/melanoma_skin_cancer_detection_app</code>.</li>
<li>Select a license (I am using MIT license).</li>
<li>Select Gradio as the Space SDK (software development kit).</li>
<li>Choose whether your Space is Public or Private (I am keeping it Public).</li>
<li>Click Create Space.</li>
<li>Clone the repository locally by running: <code>git clone https://huggingface.co/spaces/[YOUR_USERNAME]/[YOUR_SPACE_NAME]</code> in the terminal or command prompt. In our case mine would be like - <code>git clone https://huggingface.co/spaces/Chirag1994/melanoma_skin_cancer_detection_app</code>.</li>
<li>Copy/Move the contents of the downloaded <code>melanoma_skin_cancer_detection_app</code> folder to the cloned repo folder.</li>
<li>To upload files and track larger files (e.g., files that are greater than 10MB) for them we need to <a href="https://git-lfs.github.com/">install Git LFS</a> which stands for Git large File Storage.</li>
<li>Open up the cloned directory using VS code (I’m using VS code), and use the terminal (git bash in my case) and after installing the git lfs, use the command <code>git lfs install</code> to start tracking the file that we want to track. For example - git lfs track <code>"efficientnet_b5_checkpoint_fold_0.pt"</code>.</li>
<li>Create a new .gitignore file and the files &amp; folders that we don’t want git to track like :
<ul>
<li><code>__pycache__/</code></li>
<li><code>.vscode/</code></li>
<li><code>venv/</code></li>
<li><code>.gitignore</code></li>
<li><code>.gitattributes</code></li>
</ul></li>
<li>Add the rest of the files and commit them with:
<ul>
<li><code>git add .</code></li>
<li><code>git commit -m "commit message that you want"</code></li>
</ul></li>
<li>Push(load) the files to Hugging Face
<ul>
<li><code>git push</code></li>
</ul></li>
<li>It might a couple of minutes to finish and then the app will be up and running.</li>
</ol>
</section>
</section>
<section id="our-final-application-deployed-on-huggingface-spaces" class="level2">
<h2 class="anchored" data-anchor-id="our-final-application-deployed-on-huggingface-spaces">Our Final Application deployed on HuggingFace Spaces</h2>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># IPython is a library to help make Python interactive</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> IFrame</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Embed FoodVision Mini Gradio demo</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>IFrame(src<span class="op">=</span><span class="st">"https://hf.space/embed/Chirag1994/Melanoma_Skin_Cancer_Detection_App/+"</span>, width<span class="op">=</span><span class="dv">900</span>, height<span class="op">=</span><span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">

        <iframe width="900" height="750" src="https://hf.space/embed/Chirag1994/Melanoma_Skin_Cancer_Detection_App/+" frameborder="0" allowfullscreen=""></iframe>
        
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="Chirag1994/chiragsharma.github.io" data-repo-id="R_kgDOJfJZmg" data-category="General" data-category-id="DIC_kwDOJfJZms4CWR8c" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>